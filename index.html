<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Postcrab</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
// Подавляем cross-origin Script error от внешних скриптов
window.addEventListener('error', function(e) {
  if (!e.filename || e.filename === '' || e.message === 'Script error.') {
    e.preventDefault();
    return true;
  }
});
window.addEventListener('unhandledrejection', function(e) {
  if (e.reason && String(e.reason).includes('Script error')) {
    e.preventDefault();
  }
});
</script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* --- СТИЛИ (без изменений, можно оставить как в исходном файле) --- */
:root{
  --bg:#E8E8E8;--acc:#FF5722;--acc2:#FF7043;--dk:#2C2C2C;--gr:#888;--lg:#bbb;
  --gn:#4CAF50;--yl:#FFC107;--rd:#F44336;--bl:#2196F3;--pu:#9C27B0;
  --sl:-6px -6px 14px rgba(255,255,255,.85);--sd:6px 6px 14px rgba(0,0,0,.13);
  --sh:var(--sl),var(--sd);--il:inset -4px -4px 8px rgba(255,255,255,.8);
  --id:inset 4px 4px 8px rgba(0,0,0,.1);--ins:var(--il),var(--id);
  --r:20px;--rs:14px;--rp:50px
}
@keyframes pulse-dot{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.4);opacity:.7}}
@keyframes bounce-in{0%{transform:scale(0);opacity:0}60%{transform:scale(1.15)}80%{transform:scale(.95)}100%{transform:scale(1);opacity:1}}
@keyframes slide-up{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
@keyframes heart-pop{0%{transform:scale(1)}30%{transform:scale(1.4)}60%{transform:scale(.9)}100%{transform:scale(1)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes toast-in{0%{transform:translateX(-50%) translateY(14px) scale(.9);opacity:0}100%{transform:translateX(-50%) translateY(0) scale(1);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
@keyframes notif-slide{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes screen-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes modal-in{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes sugg-in{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Nunito',sans-serif;background:var(--bg);min-height:100vh;overflow-x:hidden;color:var(--dk)}
::-webkit-scrollbar{width:0}
.screen{display:none;min-height:100vh;padding-bottom:90px;animation:screen-in .22s ease}
.screen.active{display:block}
.hdr{position:sticky;top:0;z-index:100;background:var(--bg);padding:14px 18px 10px;display:flex;align-items:center;gap:10px}
.hdr-logo{display:flex;align-items:center;gap:10px;flex:1}
.logo-ic{width:40px;height:40px;background:linear-gradient(135deg,var(--acc),var(--acc2));border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(255,87,34,.35);font-size:18px;animation:float 3s ease-in-out infinite}
.logo-nm{font-size:20px;font-weight:900;color:var(--dk)}
.logo-nm span{color:var(--acc)}
.hbtn{width:40px;height:40px;background:var(--bg);border-radius:12px;border:none;display:flex;align-items:center;justify-content:center;box-shadow:var(--sh);cursor:pointer;transition:all .2s;position:relative;font-family:'Nunito',sans-serif;color:var(--gr);flex-shrink:0}
.hbtn:active{box-shadow:var(--ins);transform:scale(.95)}
.bb{width:38px;height:38px;background:var(--bg);border-radius:12px;border:none;display:flex;align-items:center;justify-content:center;box-shadow:var(--sh);cursor:pointer;transition:all .2s;color:var(--gr);flex-shrink:0}
.bb:active{box-shadow:var(--ins);transform:scale(.95)}
.bnav{position:fixed;bottom:0;left:0;right:0;z-index:200;background:var(--bg);padding:8px 6px 18px;display:flex;align-items:center;justify-content:space-around;box-shadow:0 -6px 24px rgba(0,0,0,.07);border-radius:26px 26px 0 0}
.ni{display:flex;flex-direction:column;align-items:center;gap:3px;padding:7px 10px;border-radius:var(--rs);cursor:pointer;transition:all .2s;flex:1;background:transparent;border:none}
.ni .ic{display:flex;align-items:center;justify-content:center;width:24px;height:24px;transition:transform .2s;color:var(--lg);position:relative}
.ni .lb{font-size:10px;font-weight:700;color:var(--lg);transition:color .2s;font-family:'Nunito',sans-serif}
.ni.active{background:var(--bg);box-shadow:var(--sh)}
.ni.active .lb{color:var(--acc)}
.ni.active .ic{transform:scale(1.15);color:var(--acc)}
.ni.active .ic svg{animation:bounce-in .3s ease forwards}
.nbadge{position:absolute;top:-4px;right:-6px;min-width:16px;height:16px;background:var(--acc);border-radius:8px;font-size:9px;font-weight:900;color:#fff;display:flex;align-items:center;justify-content:center;padding:0 3px}
.card{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);padding:18px}
.ci{background:var(--bg);border-radius:var(--r);box-shadow:var(--ins);padding:14px}
.btn{width:100%;padding:15px;border:none;border-radius:var(--rp);font-size:15px;font-weight:800;cursor:pointer;transition:all .2s;font-family:'Nunito',sans-serif;display:flex;align-items:center;justify-content:center;gap:8px}
.ba{background:linear-gradient(135deg,var(--acc),var(--acc2));color:#fff;box-shadow:0 8px 20px rgba(255,87,34,.3)}
.ba:active{transform:scale(.97);box-shadow:0 4px 12px rgba(255,87,34,.2)}
.bn{background:var(--bg);color:var(--acc);box-shadow:var(--sh)}
.bn:active{box-shadow:var(--ins);transform:scale(.97)}
.bg{background:var(--bg);color:var(--gr);box-shadow:var(--sh)}
.bg:active{box-shadow:var(--ins);transform:scale(.97)}
.inp{width:100%;padding:13px 16px;background:var(--bg);border:none;border-radius:var(--r);box-shadow:var(--ins);font-size:15px;font-weight:600;color:var(--dk);font-family:'Nunito',sans-serif;outline:none}
.inp::placeholder{color:var(--lg)}
.txta{width:100%;padding:13px 16px;background:var(--bg);border:none;border-radius:var(--r);box-shadow:var(--ins);font-size:14px;font-weight:600;color:var(--dk);font-family:'Nunito',sans-serif;outline:none;resize:none;min-height:88px}
.txta::placeholder{color:var(--lg)}
.flb{font-size:12px;font-weight:800;color:var(--gr);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px;display:block}
.fgr{margin-bottom:18px}
.pc{padding:0 18px}
.prc{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);padding:20px;margin-bottom:18px;position:relative;overflow:visible}
.stl{font-size:20px;font-weight:900;color:var(--dk);margin-bottom:14px;padding:0 18px}
.sinp{width:100%;padding:13px 16px 13px 44px;background:var(--bg);border:none;border-radius:var(--rp);box-shadow:var(--ins);font-size:15px;font-weight:600;color:var(--dk);font-family:'Nunito',sans-serif;outline:none}
.sinp::placeholder{color:var(--lg)}
.csc{display:flex;gap:8px;padding:0 18px 18px;overflow-x:auto;scrollbar-width:none}
.cc{flex-shrink:0;padding:9px 16px;background:var(--bg);border-radius:var(--rp);box-shadow:var(--sh);font-size:13px;font-weight:700;color:var(--gr);cursor:pointer;transition:all .2s;border:none;font-family:'Nunito',sans-serif;white-space:nowrap}
.cc.active{background:linear-gradient(135deg,var(--acc),var(--acc2));color:#fff;box-shadow:0 6px 14px rgba(255,87,34,.3)}
.chrow{display:flex;gap:8px;flex-wrap:wrap}
.ch{flex-shrink:0;padding:8px 14px;background:var(--bg);border-radius:var(--rp);box-shadow:var(--sh);font-size:13px;font-weight:700;color:var(--gr);cursor:pointer;transition:all .2s;border:none;font-family:'Nunito',sans-serif}
.ch.active{background:linear-gradient(135deg,var(--acc),var(--acc2));color:#fff;box-shadow:0 5px 12px rgba(255,87,34,.28)}
.acard{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;margin-bottom:14px;cursor:pointer;transition:all .22s cubic-bezier(.34,1.56,.64,1)}
.acard:active{transform:scale(.97) translateY(2px)}
.acard:nth-child(1){animation:slide-up .28s ease .04s both}
.acard:nth-child(2){animation:slide-up .28s ease .08s both}
.acard:nth-child(3){animation:slide-up .28s ease .12s both}
.acard:nth-child(4){animation:slide-up .28s ease .16s both}
.acard:nth-child(5){animation:slide-up .28s ease .20s both}
.acard:nth-child(6){animation:slide-up .28s ease .24s both}
.aimg{width:100%;height:170px;background:linear-gradient(135deg,#ddd,#c8c8c8);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.aimg svg{opacity:.25}
.aimg img{width:100%;height:100%;object-fit:cover}
.pinb{position:absolute;top:10px;left:10px;background:var(--dk);color:#fff;font-size:10px;font-weight:800;padding:4px 10px;border-radius:20px;display:flex;align-items:center;gap:4px}
.newb{position:absolute;top:10px;right:10px;background:var(--gn);color:#fff;font-size:9px;font-weight:800;padding:3px 8px;border-radius:20px}
.ab{padding:14px}
.acat{font-size:11px;font-weight:800;color:var(--acc);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.atl{font-size:16px;font-weight:800;color:var(--dk);margin-bottom:7px;line-height:1.3}
.ame{display:flex;align-items:center;justify-content:space-between}
.apr{font-size:21px;font-weight:900;color:var(--acc)}
.ain{font-size:12px;font-weight:600;color:var(--gr);display:flex;align-items:center;gap:3px}
.ata{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.tag{padding:3px 9px;background:var(--bg);border-radius:18px;font-size:11px;font-weight:700;color:var(--gr);box-shadow:var(--sh)}
.hsc{display:flex;gap:12px;padding:0 18px 4px;overflow-x:auto;scrollbar-width:none}
.hac{flex-shrink:0;width:190px;background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;cursor:pointer;transition:all .22s cubic-bezier(.34,1.56,.64,1)}
.hac:active{transform:scale(.97)}
.hai{height:120px;background:linear-gradient(135deg,#ddd,#c8c8c8);display:flex;align-items:center;justify-content:center;overflow:hidden}
.hai img{width:100%;height:100%;object-fit:cover}
.hai svg{opacity:.2}
.hab{padding:10px}
.hat{font-size:13px;font-weight:800;color:var(--dk);margin-bottom:3px;line-height:1.2}
.hap{font-size:15px;font-weight:900;color:var(--acc)}
.mac{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);padding:14px;margin-bottom:12px;display:flex;gap:12px;cursor:pointer;transition:all .22s cubic-bezier(.34,1.56,.64,1)}
.mac:active{transform:scale(.98)}
.mac:nth-child(n){animation:slide-up .28s ease both}
.mat{width:68px;height:68px;border-radius:var(--rs);background:linear-gradient(135deg,#ddd,#c8c8c8);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden}
.mat img{width:100%;height:100%;object-fit:cover}
.mat svg{opacity:.25}
.mai{flex:1;min-width:0}
.matl{font-size:14px;font-weight:800;color:var(--dk);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.map{font-size:16px;font-weight:900;color:var(--acc);margin-bottom:4px}
.mas{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:18px;font-size:10px;font-weight:800}
.s-act{background:rgba(76,175,80,.12);color:var(--gn)}
.s-mod{background:rgba(255,193,7,.15);color:#b8860b}
.s-rej{background:rgba(244,67,54,.12);color:var(--rd)}
.s-ina{background:rgba(0,0,0,.06);color:var(--gr)}
.mav{font-size:11px;font-weight:600;color:var(--lg);margin-top:3px;display:flex;align-items:center;gap:3px}
.tabs{display:flex;gap:7px;padding:0 18px 18px}
.tb{flex:1;padding:10px;background:var(--bg);border:none;border-radius:var(--rs);font-size:11px;font-weight:800;color:var(--gr);cursor:pointer;box-shadow:var(--sh);transition:all .2s;font-family:'Nunito',sans-serif}
.tb.active{background:linear-gradient(135deg,var(--acc),var(--acc2));color:#fff;box-shadow:0 6px 14px rgba(255,87,34,.25)}
.ph{background:var(--bg);margin:0 18px 18px;border-radius:var(--r);box-shadow:var(--sh);padding:22px;display:flex;align-items:center;gap:16px}
.pav{width:66px;height:66px;background:linear-gradient(135deg,var(--acc),var(--acc2));border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 8px 18px rgba(255,87,34,.3);animation:float 2.5s ease-in-out infinite}
.pnm{font-size:20px;font-weight:900;color:var(--dk);margin-bottom:3px}
.psi{font-size:12px;font-weight:600;color:var(--gr);margin-bottom:7px}
.tpl{display:inline-flex;align-items:center;gap:4px;padding:4px 11px;background:linear-gradient(135deg,var(--acc),var(--acc2));border-radius:18px;font-size:10px;font-weight:800;color:#fff;text-transform:uppercase}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:0 18px;margin-bottom:18px}
.si2{background:var(--bg);border-radius:var(--r);padding:16px;box-shadow:var(--sh);text-align:center}
.sv{font-size:26px;font-weight:900;color:var(--acc);line-height:1;margin-bottom:3px}
.sl{font-size:11px;font-weight:700;color:var(--gr);text-transform:uppercase;letter-spacing:.4px}
.ir{display:flex;align-items:center;justify-content:space-between;padding:13px 18px;border-bottom:1px solid rgba(0,0,0,.04);cursor:pointer;transition:background .15s}
.ir:active{background:rgba(0,0,0,.02)}
.irl{display:flex;align-items:center;gap:11px}
.iric{display:flex;align-items:center;justify-content:center;width:22px;height:22px;flex-shrink:0;color:var(--acc)}
.irlb{font-size:15px;font-weight:700;color:var(--dk)}
.irv{font-size:14px;font-weight:700;color:var(--gr)}
.ira{color:var(--lg);display:flex;align-items:center}
.prc.ft{background:linear-gradient(135deg,var(--acc),var(--acc2));box-shadow:0 12px 28px rgba(255,87,34,.3)}
.prb{display:inline-block;padding:4px 11px;border-radius:18px;font-size:10px;font-weight:800;text-transform:uppercase;background:rgba(255,87,34,.12);color:var(--acc);margin-bottom:10px}
.prc.ft .prb{background:rgba(255,255,255,.25);color:#fff}
.prn{font-size:20px;font-weight:900;color:var(--dk);margin-bottom:3px}
.prc.ft .prn{color:#fff}
.prp{font-size:34px;font-weight:900;color:var(--acc);line-height:1}
.prc.ft .prp{color:#fff}
.prp span{font-size:16px;font-weight:600;color:var(--gr)}
.prc.ft .prp span{color:rgba(255,255,255,.75)}
.prpe{font-size:13px;font-weight:600;color:var(--gr);margin-bottom:14px}
.prc.ft .prpe{color:rgba(255,255,255,.85)}
.fl{list-style:none;margin-bottom:18px}
.fl li{padding:5px 0;font-size:13px;font-weight:600;color:#666;padding-left:20px;position:relative}
.fl li::before{content:'✓';position:absolute;left:0;color:var(--acc);font-weight:900}
.prc.ft .fl li{color:rgba(255,255,255,.9)}
.prc.ft .fl li::before{color:#fff}
.pot{position:absolute;top:-1px;right:18px;background:var(--dk);color:#fff;padding:4px 12px;border-radius:0 0 12px 12px;font-size:10px;font-weight:800;text-transform:uppercase}
.prc:nth-child(1){animation:slide-up .32s ease both}
.prc:nth-child(2){animation:slide-up .32s ease .08s both}
.prc:nth-child(3){animation:slide-up .32s ease .16s both}
.fst{display:none}
.fst.active{display:block}
.sti{display:flex;align-items:center;gap:5px;padding:0 18px 18px}
.sdt{height:4px;border-radius:2px;background:var(--bg);box-shadow:var(--ins);flex:1;transition:all .3s}
.sdt.done{background:var(--acc);box-shadow:0 2px 6px rgba(255,87,34,.3)}
.cgr{display:grid;grid-template-columns:1fr 1fr;gap:11px}
.cbtn{padding:18px 14px;background:var(--bg);border:none;border-radius:var(--r);box-shadow:var(--sh);display:flex;flex-direction:column;align-items:center;gap:7px;cursor:pointer;transition:all .22s cubic-bezier(.34,1.56,.64,1);font-family:'Nunito',sans-serif}
.cbtn:active{box-shadow:var(--ins);transform:scale(.96)}
.cbtn.sel{background:linear-gradient(135deg,var(--acc),var(--acc2));box-shadow:0 8px 18px rgba(255,87,34,.3)}
.cbtn .ce{display:flex;align-items:center;justify-content:center;color:var(--gr)}
.cbtn.sel .ce{color:#fff}
.cbtn .cn{font-size:13px;font-weight:800;color:var(--dk)}
.cbtn.sel .cn{color:#fff}
.cat-hints{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.cat-hint{padding:6px 12px;background:var(--bg);border-radius:var(--rp);box-shadow:var(--sh);font-size:12px;font-weight:700;color:var(--gr);cursor:pointer;border:none;font-family:'Nunito',sans-serif;transition:all .18s;animation:sugg-in .2s ease both}
.cat-hint:active{box-shadow:var(--ins);transform:scale(.96);color:var(--acc)}
.pgr{display:flex;gap:8px;padding-bottom:4px;overflow-x:auto;scrollbar-width:none;min-height:98px;align-items:center}
.psl{width:90px;height:90px;border-radius:var(--rs);background:linear-gradient(135deg,#ddd,#c8c8c8);flex-shrink:0;position:relative;overflow:hidden}
.psl img{width:100%;height:100%;object-fit:cover}
.rmv{position:absolute;top:4px;right:4px;width:20px;height:20px;background:rgba(0,0,0,.55);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;z-index:1}
.padd{width:90px;height:90px;border-radius:var(--rs);background:var(--bg);box-shadow:var(--sh);flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--acc)}
.aslider{width:100%;height:260px;background:linear-gradient(135deg,#ddd,#c8c8c8);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.aslider svg{opacity:.2}
.aslider img{width:100%;height:100%;object-fit:cover}
.asl-nav{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:6px}
.asl-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.5);transition:all .2s}
.asl-dot.active{background:#fff;width:20px;border-radius:4px}
.adb{padding:18px}
.adp{font-size:30px;font-weight:900;color:var(--acc);margin-bottom:5px}
.adt{font-size:20px;font-weight:900;color:var(--dk);margin-bottom:14px}
.adr{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(0,0,0,.05)}
.adr:last-of-type{border-bottom:none}
.adri{display:flex;align-items:center;flex-shrink:0;color:var(--acc)}
.adrt{font-size:14px;font-weight:600;color:var(--dk)}
.adrk{font-size:11px;font-weight:700;color:var(--gr)}
.actr{display:flex;gap:10px;margin-top:18px}
.fab2{width:52px;height:52px;background:var(--bg);border-radius:16px;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--sh);transition:all .2s;flex-shrink:0;color:var(--gr)}
.fab2:active{box-shadow:var(--ins);transform:scale(.95)}
.fab2.faved{background:linear-gradient(135deg,var(--acc),var(--acc2));color:#fff;box-shadow:0 8px 20px rgba(255,87,34,.32)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.38);z-index:500;display:none;align-items:flex-end;justify-content:center}
.overlay.show{display:flex;animation:fadeIn .2s ease}
.modal{background:var(--bg);border-radius:28px 28px 0 0;padding:24px 18px 36px;width:100%;max-height:88vh;overflow-y:auto;animation:modal-in .3s ease;position:relative}
.mclose{position:absolute;right:18px;top:18px;width:34px;height:34px;background:var(--bg);border-radius:50%;border:none;box-shadow:var(--sh);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--gr)}
.mclose:active{box-shadow:var(--ins)}
.pm{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);padding:15px;margin-bottom:12px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .22s cubic-bezier(.34,1.56,.64,1)}
.pm:active{transform:scale(.97)}
.pm.sel{box-shadow:0 0 0 2.5px var(--acc),4px 4px 10px rgba(0,0,0,.1)}
.pmic{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;flex-shrink:0}
.pmt{font-size:15px;font-weight:800;color:var(--dk)}
.pmst{font-size:12px;font-weight:600;color:var(--gr)}
.notif-bar{position:fixed;top:12px;right:12px;left:12px;z-index:9998;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.notif{background:var(--dk);color:#fff;border-radius:18px;padding:12px 15px;display:flex;align-items:center;gap:11px;box-shadow:0 8px 28px rgba(0,0,0,.35);animation:notif-slide .4s cubic-bezier(.34,1.56,.64,1) forwards;cursor:pointer;pointer-events:all}
.notif-ic{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.nic-gn{background:rgba(76,175,80,.25)}
.nic-yl{background:rgba(255,193,7,.25)}
.nic-rd{background:rgba(244,67,54,.25)}
.nic-bl{background:rgba(33,150,243,.25)}
.nic-acc{background:rgba(255,87,34,.25)}
.notif-tl{font-size:13px;font-weight:800;margin-bottom:1px}
.notif-bd{font-size:11px;font-weight:600;color:rgba(255,255,255,.72);line-height:1.3}
.notif-item{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);padding:14px;margin-bottom:12px;display:flex;gap:12px;position:relative;cursor:pointer}
.notif-item.unread::after{content:'';position:absolute;top:14px;right:14px;width:8px;height:8px;background:var(--acc);border-radius:50%;animation:pulse-dot 1.6s ease-in-out infinite}
.bdot{position:absolute;top:6px;right:6px;width:8px;height:8px;background:var(--acc);border-radius:50%;animation:pulse-dot 1.6s ease-in-out infinite;box-shadow:0 0 6px rgba(255,87,34,.7)}
.admin-card{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);padding:16px;margin-bottom:12px}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.stat-box{background:var(--bg);border-radius:var(--rs);box-shadow:var(--sh);padding:14px;text-align:center}
.stat-v{font-size:24px;font-weight:900;color:var(--acc);line-height:1;margin-bottom:2px}
.stat-l{font-size:10px;font-weight:700;color:var(--gr);text-transform:uppercase;letter-spacing:.4px}
.mod-card{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden;margin-bottom:14px}
.mod-img{width:100%;height:180px;background:#ddd;display:flex;align-items:center;justify-content:center;overflow:hidden}
.mod-img img{width:100%;height:100%;object-fit:cover}
.mod-body{padding:14px}
.mod-title{font-size:16px;font-weight:800;color:var(--dk);margin-bottom:4px}
.mod-meta{font-size:12px;font-weight:600;color:var(--gr);margin-bottom:12px}
.rfb{background:var(--bg);border-radius:var(--rs);box-shadow:var(--ins);padding:12px 14px;font-size:13px;font-weight:700;color:var(--dk);margin-bottom:12px;word-break:break-all}
.rc{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,.04)}
.rav{width:38px;height:38px;border-radius:50%;background:var(--bg);box-shadow:var(--sh);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--gr)}
.rn{font-size:14px;font-weight:800;color:var(--dk)}
.rd-row{font-size:12px;font-weight:600;color:var(--gr)}
.rr{font-size:14px;font-weight:900;color:var(--acc)}
.sugg-wrap{padding:0 18px;margin-bottom:14px}
.sugg-tl{font-size:11px;font-weight:800;color:var(--gr);margin-bottom:8px;text-transform:uppercase;letter-spacing:.4px}
.sugg-list{display:flex;gap:7px;flex-wrap:wrap}
.sugg-tag{padding:7px 13px;background:var(--bg);border-radius:var(--rp);box-shadow:var(--sh);font-size:13px;font-weight:700;color:var(--dk);cursor:pointer;border:none;font-family:'Nunito',sans-serif;transition:all .2s}
.sugg-tag:active{transform:scale(.95)}
#toast{position:fixed;bottom:110px;left:50%;transform:translateX(-50%) translateY(14px);background:var(--dk);color:#fff;padding:12px 22px;border-radius:var(--rp);font-size:14px;font-weight:700;opacity:0;transition:opacity .25s,transform .3s;pointer-events:none;white-space:nowrap;z-index:9999;max-width:90vw;text-align:center}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);animation:toast-in .35s ease}
.empty{text-align:center;padding:48px 24px}
.empty .ei{margin-bottom:16px;display:flex;align-items:center;justify-content:center;animation:float 2.5s ease-in-out infinite;color:#ccc}
.empty .et{font-size:18px;font-weight:900;color:var(--dk);margin-bottom:8px}
.empty .es{font-size:14px;font-weight:600;color:var(--gr)}
.sep{height:1px;background:rgba(0,0,0,.05)}
</style>
</head>
<body>
<div id="toast"></div>
<div class="notif-bar" id="notif-bar"></div>
<div class="overlay" id="overlay" onclick="closeOverlay(event)"><div class="modal" id="modal-body"></div></div>

<!-- HOME -->
<div class="screen active" id="sc-home">
  <div class="hdr">
    <div class="hdr-logo"><div class="logo-ic" style="font-size:20px;font-weight:900;color:#fff;letter-spacing:-1px;font-family:'Nunito',sans-serif">PC</div><div class="logo-nm">Post<span>crab</span></div></div>
    <button class="hbtn" onclick="navTo('notifications')" style="position:relative">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      <div class="bdot" id="notif-dot" style="display:none"></div>
    </button>
  </div>
  <div style="padding:0 18px 14px;position:relative">
    <svg style="position:absolute;left:30px;top:50%;transform:translateY(-50%);color:var(--lg);pointer-events:none" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input class="sinp" placeholder="Поиск объявлений..." onfocus="navTo('search')">
  </div>
  <div class="csc" id="home-cats">
    <button class="cc active" onclick="filterCat('',this)">Все</button>
    <button class="cc" onclick="filterCat('Одежда',this)">Одежда</button>
    <button class="cc" onclick="filterCat('Обувь',this)">Обувь</button>
    <button class="cc" onclick="filterCat('Техника',this)">Техника</button>
    <button class="cc" onclick="filterCat('Другое',this)">Другое</button>
  </div>
  <div id="pinned-section" style="display:none">
    <div class="stl" style="margin-bottom:10px;display:flex;align-items:center;gap:8px"><svg width="18" height="18" viewBox="0 0 24 24" fill="var(--acc)" stroke="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Закреплённые</div>
    <div class="hsc" id="pinned-list"></div>
  </div>
  <div class="stl" style="margin-top:10px;display:flex;align-items:center;justify-content:space-between;padding-right:18px">
    <span>Объявления</span><span id="ads-count" style="font-size:13px;font-weight:700;color:var(--gr)"></span>
  </div>
  <div class="pc" id="ads-list"></div>
</div>

<!-- SEARCH -->
<div class="screen" id="sc-search">
  <div class="hdr">
    <button class="bb" onclick="navBack()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div style="flex:1;position:relative">
      <svg style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--lg);pointer-events:none" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input class="sinp" id="search-inp" placeholder="Поиск..." oninput="doSearch(this.value)">
    </div>
  </div>
  <div id="search-sugg"></div>
  <div class="csc" id="search-cats">
    <button class="cc active" onclick="filterCat('',this)">Все</button>
    <button class="cc" onclick="filterCat('Одежда',this)">Одежда</button>
    <button class="cc" onclick="filterCat('Обувь',this)">Обувь</button>
    <button class="cc" onclick="filterCat('Техника',this)">Техника</button>
    <button class="cc" onclick="filterCat('Другое',this)">Другое</button>
  </div>
  <div class="pc" id="search-results"></div>
</div>

<!-- AD DETAIL -->
<div class="screen" id="sc-ad-detail">
  <div class="hdr">
    <button class="bb" onclick="navBack()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="hdr-logo"><div class="logo-nm" style="font-size:15px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="ad-hdr">Объявление</div></div>
    <button class="hbtn" id="fav-hbtn" onclick="toggleFav()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></button>
  </div>
  <div class="aslider" id="ad-slider"></div>
  <div class="adb">
    <div class="adp" id="ad-det-price"></div>
    <div class="adt" id="ad-det-title"></div>
    <div id="ad-det-rows"></div>
    <div class="actr">
      <button class="btn ba" style="flex:1" onclick="contactSeller()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Написать продавцу
      </button>
      <button class="fab2" id="fav-fab" onclick="toggleFav()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></button>
    </div>
  </div>
</div>

<!-- CREATE AD -->
<div class="screen" id="sc-create">
  <div class="hdr">
    <button class="bb" onclick="backCreate()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="hdr-logo"><div class="logo-nm" style="font-size:16px">Создать объявление</div></div>
    <div id="create-limit-badge" style="font-size:11px;font-weight:800;color:var(--acc);background:rgba(255,87,34,.1);padding:4px 10px;border-radius:14px;flex-shrink:0"></div>
  </div>
  <div class="sti" id="stepi"></div>
  <!-- step 0: category -->
  <div class="fst active" id="step-0">
    <div class="stl">Категория</div>
    <div class="pc"><div class="cgr">
      <button class="cbtn" onclick="selCat('Одежда',this)"><div class="ce"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.57a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.57a2 2 0 0 0-1.34-2.23z"/></svg></div><div class="cn">Одежда</div></button>
      <button class="cbtn" onclick="selCat('Обувь',this)"><div class="ce"><svg width="34" height="26" viewBox="0 0 34 26" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18 Q2 22 6 22 L29 22 Q32 22 32 19 L32 18 Q32 16 29 16 L22 16 Q18 15 15 13 L9 10 Q6 9 4 10 Q2 12 2 16 Z"/><path d="M4 10 Q5 5 11 5 L16 5 L20 10"/><line x1="14" y1="5" x2="13" y2="12"/><line x1="12" y1="7.5" x2="19" y2="7.5"/><line x1="11.5" y1="5.8" x2="18" y2="5.8"/></svg></div><div class="cn">Обувь</div></button>
      <button class="cbtn" onclick="selCat('Техника',this)"><div class="ce"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></div><div class="cn">Техника</div></button>
      <button class="cbtn" onclick="selCat('Другое',this)"><div class="ce"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10H3L5 3h14l2 7z"/><path d="M3 10l2 11h14l2-11"/><path d="M12 3v7"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div><div class="cn">Другое</div></button>
    </div></div>
  </div>
  <!-- step 1: details -->
  <div class="fst" id="step-1">
    <div class="pc">
      <div class="fgr">
        <label class="flb">Название *</label>
        <div class="cat-hints" id="title-hints" style="display:none;margin-bottom:8px"></div>
        <input class="inp" id="ad-title" placeholder="Введите название товара">
      </div>
      <div class="fgr">
        <label class="flb">Описание</label>
        <textarea class="txta" id="ad-desc" placeholder="Расскажите подробнее..."></textarea>
        <div class="cat-hints" id="desc-hints" style="display:none;margin-top:8px"></div>
      </div>
      <div class="fgr" id="size-gr" style="display:none"><label class="flb">Размер</label><input class="inp" id="ad-size" placeholder="XS/S/M/L/XL или 42/43..."></div>
      <div class="fgr"><label class="flb">Состояние *</label>
        <div class="chrow">
          <button class="ch" onclick="selChip(this,'condition','Новое')">Новое</button>
          <button class="ch" onclick="selChip(this,'condition','Отличное')">Отличное</button>
          <button class="ch" onclick="selChip(this,'condition','Хорошее')">Хорошее</button>
          <button class="ch" onclick="selChip(this,'condition','Удовл.')">Удовл.</button>
        </div>
      </div>
      <button class="btn ba" onclick="nextStep()">Далее →</button>
    </div>
  </div>
  <!-- step 2: price/city/delivery -->
  <div class="fst" id="step-2">
    <div class="pc">
      <div class="fgr"><label class="flb">Цена ₽ *</label><input class="inp" id="ad-price" type="number" min="0" placeholder="0 = бесплатно"></div>
      <div class="fgr"><label class="flb">Город</label><input class="inp" id="ad-city" placeholder="Москва, СПб..."></div>
      <div class="fgr"><label class="flb">Способы доставки</label>
        <div class="chrow" id="deliv-chips">
          <button class="ch" onclick="togDeliv(this,'СДЭК')">СДЭК</button>
          <button class="ch" onclick="togDeliv(this,'Почта России')">Почта России</button>
          <button class="ch" onclick="togDeliv(this,'Boxberry')">Boxberry</button>
          <button class="ch" onclick="togDeliv(this,'DPD')">DPD</button>
          <button class="ch" onclick="togDeliv(this,'ПЭК')">ПЭК</button>
          <button class="ch" onclick="togDeliv(this,'КСЭ')">КСЭ</button>
          <button class="ch" onclick="togDeliv(this,'Яндекс Доставка')">Яндекс Доставка</button>
          <button class="ch" onclick="togDeliv(this,'Авито')">Авито</button>
          <button class="ch" onclick="togDeliv(this,'Самовывоз')">Самовывоз</button>
          <button class="ch" onclick="togDelivOther(this)">Другое</button>
        </div>
        <div id="deliv-other-wrap" style="display:none;margin-top:10px">
          <input class="inp" id="deliv-other-inp" placeholder="Укажите способ доставки..." oninput="updateDelivOther(this.value)">
        </div>
      </div>
      <button class="btn ba" onclick="nextStep()">Далее →</button>
    </div>
  </div>
  <!-- step 3: photos -->
  <div class="fst" id="step-3">
    <div class="pc">
      <div class="stl" style="padding:0;margin-bottom:6px">Фотографии</div>
      <p style="font-size:13px;font-weight:600;color:var(--gr);margin-bottom:18px">До 10 фото · Первое — главное</p>
      <input type="file" id="photo-file" accept="image/*" multiple style="display:none" onchange="handlePhotos(this)">
      <div id="photo-dropzone" onclick="document.getElementById('photo-file').click()" style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;width:100%;min-height:200px;border-radius:20px;background:var(--bg);box-shadow:var(--ins);cursor:pointer;transition:all .2s;margin-bottom:14px">
        <div style="width:72px;height:72px;border-radius:20px;background:rgba(255,87,34,.08);display:flex;align-items:center;justify-content:center">
          <svg width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="var(--acc)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
        </div>
        <div style="text-align:center">
          <div style="font-size:15px;font-weight:800;color:var(--dk);margin-bottom:4px">Добавить фото</div>
          <div style="font-size:12px;font-weight:600;color:var(--gr)">Нажмите чтобы выбрать из галереи</div>
        </div>
      </div>
      <div class="pgr" id="photo-grid"></div>
      <div id="photo-add-more" style="display:none;margin-top:8px;margin-bottom:14px">
        <button onclick="document.getElementById('photo-file').click()" style="width:100%;padding:12px;background:var(--bg);border:none;border-radius:var(--r);box-shadow:var(--sh);font-size:13px;font-weight:800;color:var(--acc);cursor:pointer;font-family:'Nunito',sans-serif;display:flex;align-items:center;justify-content:center;gap:8px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Добавить ещё фото
        </button>
      </div>
      <button class="btn ba" style="margin-bottom:10px" onclick="nextStep()">Далее →</button>
      <button class="btn bg" onclick="nextStep()">Пропустить</button>
    </div>
  </div>
  <!-- step 4: contact + submit -->
  <div class="fst" id="step-4">
    <div class="pc">
      <div class="fgr"><label class="flb">Контакт *</label><input class="inp" id="ad-contact" placeholder="@telegram или номер телефона">
        <p style="font-size:12px;font-weight:600;color:var(--gr);margin-top:6px">Покупатели напишут на этот контакт</p>
      </div>
      <div id="create-preview" style="margin-bottom:18px"></div>
      <button class="btn ba" onclick="submitAd()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        Отправить на модерацию
      </button>
    </div>
  </div>
</div>

<!-- MY ADS -->
<div class="screen" id="sc-my-ads">
  <div class="hdr">
    <div class="hdr-logo"><div class="logo-nm" style="font-size:17px">Мои объявления</div></div>
    <button class="hbtn" onclick="tryCreate()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
  </div>
  <div class="tabs">
    <button class="tb active" id="tab-active" onclick="setTab('active',this)">Активные</button>
    <button class="tb" id="tab-moderation" onclick="setTab('moderation',this)">Модерация</button>
    <button class="tb" id="tab-archive" onclick="setTab('archive',this)">Архив</button>
  </div>
  <div class="pc" id="my-ads-list"></div>
</div>

<!-- MY AD DETAIL -->
<div class="screen" id="sc-my-ad-detail">
  <div class="hdr">
    <button class="bb" onclick="navBack()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="hdr-logo"><div class="logo-nm" style="font-size:15px" id="my-ad-hdr">Объявление</div></div>
  </div>
  <div class="pc" id="my-ad-detail-body" style="padding-top:14px"></div>
</div>

<!-- FAVOURITES -->
<div class="screen" id="sc-favs">
  <div class="hdr"><div class="hdr-logo"><div class="logo-nm" style="font-size:17px;display:flex;align-items:center;gap:8px"><svg width="18" height="18" viewBox="0 0 24 24" fill="var(--acc)" stroke="none"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>Избранное</div></div></div>
  <div class="pc" id="favs-list"></div>
</div>

<!-- PROFILE -->
<div class="screen" id="sc-profile">
  <div class="hdr">
    <div class="hdr-logo"><div class="logo-nm" style="font-size:17px">Профиль</div></div>
    <button class="hbtn" onclick="navTo('notifications')" style="position:relative">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      <div class="bdot" id="notif-dot2" style="display:none"></div>
    </button>
  </div>
  <div class="ph">
    <div class="pav"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.58-7 8-7s8 3 8 7"/></svg></div>
    <div><div class="pnm" id="prof-name">Пользователь</div><div class="psi" id="prof-sub">Тариф: Free</div><div class="tpl" id="prof-tariff">FREE</div></div>
  </div>
  <div class="sg">
    <div class="si2"><div class="sv" id="prof-ads">0</div><div class="sl">Объявлений</div></div>
    <div class="si2"><div class="sv" id="prof-views">0</div><div class="sl">Просмотров</div></div>
  </div>
  <div class="card" style="margin:0 18px 14px;padding:0">
    <div class="ir" onclick="navTo('my-ads');setTab('active')">
      <div class="irl"><div class="iric"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3.5" cy="6" r="1.2" fill="currentColor"/><circle cx="3.5" cy="12" r="1.2" fill="currentColor"/><circle cx="3.5" cy="18" r="1.2" fill="currentColor"/></svg></div><div class="irlb">Мои объявления</div></div>
      <div class="ira"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></div>
    </div>
    <div class="sep"></div>
    <div class="ir" onclick="navTo('subscriptions')">
      <div class="irl"><div class="iric"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></div><div class="irlb">Тарифы и подписки</div></div>
      <div class="ira"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></div>
    </div>
    <div class="sep"></div>
    <div class="ir" onclick="navTo('pin-ad')">
      <div class="irl"><div class="iric"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6z"/></svg></div><div class="irlb">Закрепить объявление</div></div>
      <div class="ira"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></div>
    </div>
    <div class="sep"></div>
    <div class="ir" onclick="navTo('referral')">
      <div class="irl"><div class="iric"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div><div class="irlb">Реферальная программа</div></div>
      <div class="ira" style="gap:5px"><div class="irv" id="ref-bal-prof" style="color:var(--acc)">0₽</div><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></div>
    </div>
    <div class="sep"></div>
    <div class="ir" onclick="navTo('notifications')">
      <div class="irl"><div class="iric"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></div><div class="irlb">Уведомления</div></div>
      <div class="ira" style="gap:5px"><div class="irv" id="notif-count-prof" style="color:var(--acc)"></div><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></div>
    </div>
    <div class="sep" id="admin-sep" style="display:none"></div>
    <div class="ir" id="admin-row" style="display:none" onclick="navTo('admin')">
      <div class="irl"><div class="iric" style="color:var(--rd)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--rd)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div><div class="irlb" style="color:var(--rd)">Администрирование</div></div>
      <div class="ira"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></div>
    </div>
  </div>
  <div style="padding:0 18px;font-size:12px;font-weight:600;color:var(--lg);text-align:center" id="prof-id"></div>
</div>

<!-- SUBSCRIPTIONS -->
<div class="screen" id="sc-subscriptions">
  <div class="hdr">
    <button class="bb" onclick="navBack()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="hdr-logo"><div class="logo-nm" style="font-size:17px">Тарифы</div></div>
  </div>
  <div class="pc">
    <div class="fgr" style="display:flex;gap:8px">
      <input class="inp" id="promo-inp" placeholder="Промокод (необязательно)">
      <button class="btn ba" style="width:auto;padding:13px 18px;flex-shrink:0" onclick="applyPromo()">OK</button>
    </div>
    <div id="promo-applied" style="display:none;margin-bottom:14px"></div>
    <div class="prc" id="free-plan">
      <div class="prb">Free</div>
      <div class="prn">Бесплатный</div>
      <div class="prp">0₽ <span>/мес</span></div>
      <div class="prpe">Базовые возможности</div>
      <ul class="fl"><li>1 объявление в день</li><li>До 10 фото</li><li>Базовый поиск</li></ul>
      <button class="btn bg" onclick="toast('Вы уже на бесплатном тарифе')">Активен</button>
    </div>
    <div class="prc">
      <div class="prb">Standard</div>
      <div class="prn">Стандарт</div>
      <div class="prp" id="std-price">299₽ <span>/мес</span></div>
      <div class="prpe">Для активных продавцов</div>
      <ul class="fl"><li>3 объявления в день</li><li>1 закреп 24ч/мес</li><li>До 10 фото</li><li>Приоритет в поиске</li></ul>
      <button class="btn ba" onclick="openPayment('Standard')">Оформить</button>
    </div>
    <div class="prc ft">
      <div class="pot">Хит</div>
      <div class="prb">PRO</div>
      <div class="prn">Профи</div>
      <div class="prp" id="pro-price">899₽ <span>/мес</span></div>
      <div class="prpe">Максимум возможностей</div>
      <ul class="fl"><li>Безлимит объявлений</li><li>3 закрепа 168ч/мес</li><li>До 10 фото</li><li>Топ выдачи</li><li>PRO значок</li></ul>
      <button class="btn" style="background:#fff;color:var(--acc);box-shadow:0 6px 14px rgba(0,0,0,.15)" onclick="openPayment('PRO')">Оформить PRO</button>
    </div>
  </div>
</div>

<!-- REFERRAL -->
<div class="screen" id="sc-referral">
  <div class="hdr">
    <button class="bb" onclick="navBack()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="hdr-logo"><div class="logo-nm" style="font-size:17px;display:flex;align-items:center;gap:8px"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Рефералы</div></div>
  </div>
  <div class="pc">
    <div style="background:linear-gradient(135deg,var(--acc),var(--acc2));border-radius:var(--r);padding:22px;margin-bottom:18px;box-shadow:0 12px 28px rgba(255,87,34,.3)">
      <div style="font-size:12px;font-weight:700;color:rgba(255,255,255,.8);margin-bottom:3px">Реферальный баланс</div>
      <div style="font-size:36px;font-weight:900;color:#fff;line-height:1;margin-bottom:3px" id="ref-bal">0₽</div>
      <div style="font-size:13px;font-weight:600;color:rgba(255,255,255,.75)">Всего заработано: <span id="ref-total">0₽</span></div>
    </div>
    <div class="sg" style="padding:0;margin-bottom:18px">
      <div class="si2"><div class="sv" id="ref-cnt">0</div><div class="sl">Приглашено</div></div>
      <div class="si2"><div class="sv" id="ref-act">0</div><div class="sl">Купили подписку</div></div>
    </div>
    <div class="card" style="margin-bottom:18px">
      <label class="flb" style="margin-bottom:10px">Ваша реферальная ссылка</label>
      <div class="rfb" id="ref-link">https://t.me/postcrab_bot?start=ref_...</div>
      <div style="display:flex;gap:8px">
        <button class="btn ba" style="flex:1" onclick="copyRef()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Скопировать</button>
        <button class="btn bn" style="flex:1" onclick="shareRef()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg> Поделиться</button>
      </div>
    </div>
    <div style="font-size:13px;font-weight:800;color:var(--dk);margin-bottom:12px">Мои рефералы</div>
    <div id="ref-list"></div>
    <button class="btn bn" style="margin-top:12px" onclick="openPayment('ref_balance')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polygon points="6 3 18 3 22 9 12 22 2 9"/><line x1="2" y1="9" x2="22" y2="9"/><line x1="12" y1="3" x2="6" y2="9"/><line x1="12" y1="3" x2="18" y2="9"/><line x1="6" y1="9" x2="12" y2="22"/><line x1="18" y1="9" x2="12" y2="22"/></svg> Потратить баланс на тариф</button>
  </div>
</div>

<!-- PIN AD -->
<div class="screen" id="sc-pin-ad">
  <div class="hdr">
    <button class="bb" onclick="navBack()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="hdr-logo"><div class="logo-nm" style="font-size:17px">⭐ Закрепить</div></div>
  </div>
  <div class="pc">
    <div class="card" style="margin-bottom:18px">
      <div style="font-size:14px;font-weight:700;color:var(--dk);margin-bottom:6px">Что такое закреп?</div>
      <div style="font-size:13px;font-weight:600;color:var(--gr);line-height:1.6">Закреплённые объявления показываются первыми в ленте. Доступно только по подписке.</div>
    </div>
    <div id="pin-ad-list"></div>
  </div>
</div>

<!-- NOTIFICATIONS -->
<div class="screen" id="sc-notifications">
  <div class="hdr">
    <button class="bb" onclick="navBack()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="hdr-logo"><div class="logo-nm" style="font-size:17px;display:flex;align-items:center;gap:8px"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>Уведомления</div></div>
    <button class="hbtn" onclick="markAllRead()" style="font-size:10px;font-weight:800;color:var(--acc);width:auto;padding:0 10px;box-shadow:none">Всё прочитано</button>
  </div>
  <div class="pc" id="notif-list"></div>
</div>

<!-- ADMIN -->
<div class="screen" id="sc-admin">
  <div class="hdr">
    <button class="bb" onclick="navBack()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
    <div class="hdr-logo"><div class="logo-nm" style="font-size:17px;color:var(--rd);display:flex;align-items:center;gap:8px"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--rd)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Админ-панель</div></div>
  </div>
  <div class="pc">
    <div style="font-size:11px;font-weight:800;color:var(--gr);margin-bottom:12px;text-transform:uppercase;letter-spacing:.4px">Статистика</div>
    <div class="stat-grid">
      <div class="stat-box"><div class="stat-v" id="stat-users">0</div><div class="stat-l">Пользователей</div></div>
      <div class="stat-box"><div class="stat-v" id="stat-ads">0</div><div class="stat-l">Объявлений</div></div>
      <div class="stat-box"><div class="stat-v" id="stat-active">0</div><div class="stat-l">Активных</div></div>
      <div class="stat-box"><div class="stat-v" id="stat-mod">0</div><div class="stat-l">Модерация</div></div>
    </div>
    <div style="font-size:11px;font-weight:800;color:var(--gr);margin-bottom:12px;text-transform:uppercase;letter-spacing:.4px">Очередь модерации</div>
    <div id="admin-mod-queue"></div>
    <div style="font-size:11px;font-weight:800;color:var(--gr);margin:18px 0 12px;text-transform:uppercase;letter-spacing:.4px">Платежи (ожидают)</div>
    <div id="admin-payments-list"></div>
    <div style="font-size:11px;font-weight:800;color:var(--gr);margin:18px 0 12px;text-transform:uppercase;letter-spacing:.4px">Рассылка</div>
    <div class="fgr"><textarea class="txta" id="broadcast-text" placeholder="Сообщение для всех пользователей..." style="min-height:100px"></textarea></div>
    <button class="btn ba" onclick="sendBroadcast()" style="margin-bottom:18px">Отправить рассылку</button>
    <div style="font-size:11px;font-weight:800;color:var(--gr);margin-bottom:12px;text-transform:uppercase;letter-spacing:.4px">Промокоды</div>
    <div id="promo-list-admin"></div>
    <button class="btn bn" style="margin-top:10px" onclick="showPromoCreate()">+ Создать промокод</button>
  </div>
</div>

<!-- NAV -->
<nav class="bnav">
  <button class="ni active" id="nav-home" onclick="navTo('home')">
    <span class="ic"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z"/><polyline points="9 21 9 12 15 12 15 21"/></svg></span>
    <span class="lb">Главная</span>
  </button>
  <button class="ni" id="nav-search" onclick="navTo('search')">
    <span class="ic"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
    <span class="lb">Поиск</span>
  </button>
  <button class="ni" id="nav-create" onclick="tryCreate()">
    <span class="ic"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></span>
    <span class="lb">Создать</span>
  </button>
  <button class="ni" id="nav-favs" onclick="navTo('favs')">
    <span class="ic"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></span>
    <span class="lb">Избранное</span>
  </button>
  <button class="ni" id="nav-profile" onclick="navTo('profile')">
    <span class="ic"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.58-7 8-7s8 3 8 7"/></svg><div class="nbadge" id="nav-profile-badge" style="display:none"></div></span>
    <span class="lb">Профиль</span>
  </button>
</nav>

<script>
'use strict';
// ═══════════ КОНФИГУРАЦИЯ ИЗ БОТА ═══════════
const BOT_TOKEN = "8200896974:AAHdB0_Jbi5ykiRcJd5nEApbba_uz3Od004";
const ADMIN_CHANNEL_ID = "@postcrab";
const ADMIN_USER_IDS = [6115882628];
const TARIFFS = {
  Free: { daily_ads: 1, pins_per_month: 0, pin_hours: 0, photo_limit: 10, price: 0 },
  Standard: { daily_ads: 3, pins_per_month: 1, pin_hours: 24, photo_limit: 10, price: 299 },
  PRO: { daily_ads: Infinity, pins_per_month: 3, pin_hours: 168, photo_limit: 10, price: 899 }
};
const PAYMENT_DETAILS = {
  yoomoney_standard: "https://yoomoney.ru/to/4100119456604619",
  yoomoney_pro: "https://yoomoney.ru/to/4100119456604619",
  crypto_standard: "t.me/send?start=IVRWI4KCIZoj",
  crypto_pro: "t.me/send?start=IVRMtMS6xa0a",
  tinkoff_account: "2200701043238127"
};
const CRYPTO_LINKS = {
  5: "https://crypto-link-5percent.com",
  10: "https://crypto-link-10percent.com",
  15: "https://crypto-link-15percent.com",
  20: "https://crypto-link-20percent.com",
  25: "https://crypto-link-25percent.com",
  30: "https://crypto-link-30percent.com",
  35: "https://crypto-link-35percent.com",
  40: "https://crypto-link-40percent.com",
  45: "https://crypto-link-45percent.com",
  50: "https://crypto-link-50percent.com",
  55: "https://crypto-link-55percent.com",
  60: "https://crypto-link-60percent.com",
  65: "https://crypto-link-65percent.com",
  70: "https://crypto-link-70percent.com",
  75: "https://crypto-link-75percent.com",
  80: "https://crypto-link-80percent.com"
};
const REFERRAL_PERCENT = 5;
const BOT_NAME = "postcrab_bot";

// СИНОНИМЫ ИЗ БОТА
const SEARCH_SYNONYMS = {
  'айфон': ['iphone', 'айфон', 'apple', 'ифон'],
  'iphone': ['iphone', 'айфон', 'apple', 'ифон'],
  'ифон': ['iphone', 'айфон', 'apple'],
  'apple': ['iphone', 'айфон', 'apple'],
  'самсунг': ['samsung', 'самсунг', 'галакси'],
  'samsung': ['samsung', 'самсунг', 'галакси'],
  'галакси': ['samsung', 'галакси', 'galaxy'],
  'кроссовки': ['кроссовки', 'кеды', 'обувь', 'sneakers', 'keds'],
  'кеды': ['кроссовки', 'кеды', 'обувь', 'sneakers'],
  'sneakers': ['кроссовки', 'кеды', 'обувь', 'sneakers'],
  'техника': ['техника', 'электроника', 'gadgets', 'electronics'],
  'ноутбук': ['ноутбук', 'laptop', 'ноут', 'лэптоп'],
  'laptop': ['ноутбук', 'laptop', 'ноут'],
  'телефон': ['телефон', 'смартфон', 'phone', 'smartphone'],
  'phone': ['телефон', 'смартфон', 'phone'],
  'диван': ['диван', 'sofa', 'диванчик'],
  'sofa': ['диван', 'sofa', 'диванчик'],
  'машина': ['машина', 'автомобиль', 'car', 'auto'],
  'car': ['машина', 'автомобиль', 'car'],
  'квартира': ['квартира', 'apartment', 'flat', 'жилье'],
  'apartment': ['квартира', 'apartment', 'flat'],
};

// Транслитерация
const TRANSLIT_MAP = {
  'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'yo','ж':'zh','з':'z','и':'i','й':'j',
  'к':'k','л':'l','м':'m','н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f',
  'х':'h','ц':'ts','ч':'ch','ш':'sh','щ':'sch','ъ':'','ы':'y','ь':'','э':'e','ю':'yu','я':'ya'
};
function translit(s) {
  return s.split('').map(c => TRANSLIT_MAP[c.toLowerCase()] || c.toLowerCase()).join('');
}
function normSearch(q) { return q.trim().toLowerCase(); }
function getSearchTerms(q) {
  q = normSearch(q);
  const terms = new Set([q]);
  Object.keys(SEARCH_SYNONYMS).forEach(k => {
    if (k.includes(q) || q.includes(k)) {
      terms.add(k);
      SEARCH_SYNONYMS[k].forEach(s => terms.add(s));
    }
  });
  const tq = translit(q);
  if (tq !== q) terms.add(tq);
  return [...terms];
}

// Шаблоны категорий
const CAT_TEMPLATES = {
  'Одежда': {
    title:'Например: Куртка зимняя H&M',
    desc:'Например: Куртка в хорошем состоянии, надевал(а) пару раз. Размер подходит на 46-48. Без дефектов.',
    size:'XS / S / M / L / XL / XXL',
    hints:['Куртка','Пуховик','Джинсы','Платье','Футболка','Худи','Пальто','Спортивный костюм'],
    descHints:['Размер подходит на...','Надевал(а) несколько раз','Без дефектов','Есть небольшой изъян (описание)'],
  },
  'Обувь':{
    title:'Например: Кроссовки Nike Air Max 42р',
    desc:'Например: Кроссовки в отличном состоянии. Размер 42. Подошва не стёрта, без потёртостей.',
    size:'38 / 39 / 40 / 41 / 42 / 43 / 44 / 45',
    hints:['Кроссовки','Ботинки','Кеды','Сапоги','Туфли','Сандали','Кроксы','Угги'],
    descHints:['Размер...','Подошва целая','Без потёртостей','Носились мало'],
  },
  'Техника':{
    title:'Например: iPhone 14 Pro 256GB',
    desc:'Например: Телефон в идеальном состоянии. АКБ 89%. Комплект полный: коробка, зарядка. Торг уместен.',
    size:'',
    hints:['iPhone','Samsung','Ноутбук','MacBook','iPad','Наушники','Часы','Игровая приставка','Фотоаппарат','Планшет'],
    descHints:['Состояние АКБ...%','Полный комплект','Есть/нет царапин','Торг уместен','Самовывоз или доставка'],
  },
  'Другое':{
    title:'Например: Детский велосипед 20"',
    desc:'Например: Продаю в связи с ненадобностью. Состояние хорошее, всё работает.',
    size:'',
    hints:['Мебель','Книги','Игрушки','Велосипед','Спортинвентарь','Растения','Посуда','Стройматериалы'],
    descHints:['В связи с переездом','Состояние хорошее','Всё работает','Самовывоз'],
  },
};

// ═══════════ STORAGE (изолированный по пользователю) ═══════════
let _storagePrefix = 'pc_';
const LS = k => { try { return JSON.parse(localStorage.getItem(_storagePrefix + k)); } catch { return null; } };
const SS = (k, v) => { try { localStorage.setItem(_storagePrefix + k, JSON.stringify(v)); } catch {} };

const S = {
  user: LS('user') || { name: 'Пользователь', tg_id: null, tariff: 'Free', tariff_end: null, pins_used: 0, ref_balance: 0, ref_total: 0, daily_ads: 0, last_daily_reset: null, views_total: 0 },
  ads: LS('ads') || [],              // все активные объявления (из канала)
  myAds: LS('my_ads') || [],         // мои объявления (включая на модерации)
  favs: LS('favs') || [],            // id избранных
  notifs: LS('notifs') || [],
  promoCodes: LS('promos') || [],    // список промокодов (для админа)
  payments: LS('payments') || [],    // история платежей
  referrals: LS('refs') || [],       // список рефералов
  searchHist: LS('search_hist') || [],
  curAdId: null,
  prevSc: 'home',
  curSc: 'home',
  createStep: 0,
  newAd: {},
  photos: [],
  deliveries: [],
  promoDiscount: 0,
  promoCode: '',
  curCat: '',
  curTab: 'active',
  selPayTariff: '',
  selPayMethod: '',
  curSlide: 0,
};
function save() {
  SS('user', S.user);
  SS('ads', S.ads);
  SS('my_ads', S.myAds);
  SS('favs', S.favs);
  SS('notifs', S.notifs);
  SS('promos', S.promoCodes);
  SS('payments', S.payments);
  SS('refs', S.referrals);
  SS('search_hist', S.searchHist);
}

// ========== НОВЫЕ ФУНКЦИИ ДЛЯ ИНТЕГРАЦИИ С БОТОМ ==========
async function sendBotAction(action, payload = {}) {
    return new Promise((resolve, reject) => {
        const tg = window.Telegram.WebApp;
        const reqId = Date.now() + Math.random();
        const handler = (event) => {
            if (event.data && event.data.webAppData) {
                try {
                    const response = JSON.parse(event.data.webAppData);
                    if (response.reqId === reqId) {
                        tg.offEvent('webAppData', handler);
                        resolve(response);
                    }
                } catch (e) {}
            }
        };
        tg.onEvent('webAppData', handler);
        tg.sendData(JSON.stringify({
            reqId: reqId,
            action: action,
            ...payload
        }));
        setTimeout(() => {
            tg.offEvent('webAppData', handler);
            reject(new Error('Timeout'));
        }, 10000);
    });
}

async function loadInitialData() {
    try {
        const data = await sendBotAction('get_initial_data');
        if (data.ok) {
            S.user = data.user;
            S.ads = data.ads;
            S.myAds = data.my_ads;
            S.favs = data.favorites;
            S.notifs = data.notifications || [];
            S.referrals = data.referrals || {};
            if (data.promocodes) S.promoCodes = data.promocodes;
            if (data.crypto_links) S.cryptoLinks = data.crypto_links;
            save();
            return true;
        }
    } catch (e) {
        console.warn('Failed to load from bot, using local storage', e);
    }
    return false;
}

// ═══════════ INITIALIZATION ═══════════
function initDemo() {
  if (S.notifs.length === 0) {
    S.notifs.push({
      id: Date.now(),
      type: 'info',
      icon: '★',
      iconCls: 'nic-acc',
      title: 'Добро пожаловать в Postcrab!',
      body: 'Создайте первое объявление — оно пройдёт модерацию и появится в ленте!',
      time: Date.now(),
      read: false,
    });
    save();
  }
}

// ═══════════ UTILS ═══════════
function esc(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
function fmtPrice(p) { return p > 0 ? p.toLocaleString('ru') + '₽' : 'Бесплатно'; }
function timeAgo(ts) {
  const d = Math.floor((Date.now() - ts) / 1000);
  if (d < 60) return 'только что';
  if (d < 3600) return Math.floor(d / 60) + 'м назад';
  if (d < 86400) return Math.floor(d / 3600) + 'ч назад';
  return Math.floor(d / 86400) + 'д назад';
}
let _tt;
function toast(msg, dur = 2600) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(_tt);
  _tt = setTimeout(() => t.classList.remove('show'), dur);
}

// ═══════════ NAVIGATION ═══════════
const SCREENS = {
  home: 'sc-home',
  search: 'sc-search',
  create: 'sc-create',
  'my-ads': 'sc-my-ads',
  'my-ad-detail': 'sc-my-ad-detail',
  favs: 'sc-favs',
  profile: 'sc-profile',
  subscriptions: 'sc-subscriptions',
  referral: 'sc-referral',
  'pin-ad': 'sc-pin-ad',
  notifications: 'sc-notifications',
  admin: 'sc-admin',
  'ad-detail': 'sc-ad-detail',
};
const NAVMAP = {
  home: 'nav-home',
  search: 'nav-search',
  create: 'nav-create',
  'my-ads': 'nav-profile',
  profile: 'nav-profile',
  'my-ad-detail': 'nav-profile',
  subscriptions: 'nav-profile',
  referral: 'nav-profile',
  'pin-ad': 'nav-profile',
  notifications: 'nav-profile',
  admin: 'nav-profile',
  'ad-detail': null,
  favs: 'nav-favs',
};

function navTo(sc) {
  S.prevSc = S.curSc;
  S.curSc = sc;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const sid = SCREENS[sc];
  if (sid) document.getElementById(sid).classList.add('active');
  document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));
  const nid = NAVMAP[sc];
  if (nid) document.getElementById(nid).classList.add('active');
  window.scrollTo(0, 0);
  const r = {
    home: () => { renderHome(); renderPinned(); },
    search: () => { const inp = document.getElementById('search-inp'); inp.value = ''; renderSearchSugg(); doSearch(''); setTimeout(() => inp.focus(), 200); },
    favs: renderFavs,
    profile: renderProfile,
    'my-ads': () => setTab(S.curTab),
    subscriptions: renderSubs,
    referral: renderReferral,
    'pin-ad': renderPinAd,
    notifications: renderNotifications,
    admin: renderAdmin,
  };
  if (r[sc]) r[sc]();
}
function navBack() { navTo(S.prevSc || 'home'); }

// ═══════════ SEARCH ═══════════
let _st;
function doSearch(q) { clearTimeout(_st); _st = setTimeout(() => _doSearch(q), 180); }
function _doSearch(q) {
  q = q.trim().toLowerCase();
  if (q && !S.searchHist.includes(q)) { S.searchHist.unshift(q); S.searchHist = S.searchHist.slice(0, 10); save(); }
  const terms = getSearchTerms(q);
  let res = S.ads.filter(a => a.status === 'active');
  if (q) {
    res = res.filter(a => {
      const hay = normSearch(`${a.title} ${a.desc || ''} ${a.category}`);
      return terms.some(t => hay.includes(t)) || terms.some(t => translit(hay).includes(translit(t)));
    });
  }
  if (S.curCat) res = res.filter(a => a.category === S.curCat);
  const now = Date.now();
  res.sort((a, b) => {
    const ap = a.pinned_until && a.pinned_until > now ? 0 : 1;
    const bp = b.pinned_until && b.pinned_until > now ? 0 : 1;
    if (ap !== bp) return ap - bp;
    return b.created_at - a.created_at;
  });
  renderAdList('search-results', res);
  renderSearchSugg();
}
function renderSearchSugg() {
  const el = document.getElementById('search-sugg'); if (!el) return;
  const hist = S.searchHist.slice(0, 6);
  const activeAds = S.ads.filter(a => a.status === 'active' && a.views > 0);
  activeAds.sort((a, b) => (b.views || 0) - (a.views || 0));
  const popAds = activeAds.slice(0, 6);
  let h = '';
  if (hist.length) {
    h += `<div class="sugg-wrap"><div class="sugg-tl">История</div><div class="sugg-list">`;
    hist.forEach(t => h += `<button class="sugg-tag" onclick="searchTag('${esc(t)}')">${esc(t)}</button>`);
    h += `</div></div>`;
  }
  if (popAds.length) {
    h += `<div class="sugg-wrap"><div class="sugg-tl">Популярное</div><div class="sugg-list">`;
    popAds.forEach(a => h += `<button class="sugg-tag" onclick="openAd(${a.id})">${esc(a.title)}</button>`);
    h += `</div></div>`;
  }
  el.innerHTML = h;
}
function searchTag(t) { document.getElementById('search-inp').value = t; doSearch(t); }
function filterCat(cat, el) {
  S.curCat = cat;
  const cats = el.closest('.csc');
  if (cats) cats.querySelectorAll('.cc').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  if (S.curSc === 'home') { renderHome(); renderPinned(); }
  else if (S.curSc === 'search') doSearch(document.getElementById('search-inp')?.value || '');
}

// ═══════════ HOME & AD LIST ═══════════
function renderHome() {
  const now = Date.now();
  let ads = S.ads.filter(a => a.status === 'active');
  if (S.curCat) ads = ads.filter(a => a.category === S.curCat);
  ads.sort((a, b) => {
    const ap = a.pinned_until && a.pinned_until > now ? 0 : 1;
    const bp = b.pinned_until && b.pinned_until > now ? 0 : 1;
    if (ap !== bp) return ap - bp;
    return b.created_at - a.created_at;
  });
  document.getElementById('ads-count').textContent = ads.length + ' объявлений';
  renderAdList('ads-list', ads);
}
function renderPinned() {
  const now = Date.now();
  const pinned = S.ads.filter(a => a.status === 'active' && a.pinned_until && a.pinned_until > now);
  const el = document.getElementById('pinned-list');
  const sec = document.getElementById('pinned-section');
  if (!pinned.length) { sec.style.display = 'none'; return; }
  sec.style.display = 'block';
  el.innerHTML = pinned.map(a => `
    <div class="hac" onclick="openAd(${a.id})">
      <div class="hai">${a.photos && a.photos.length ? `<img src="${esc(a.photos[0])}" loading="lazy">` : `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.18)" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>`}</div>
      <div class="hab">
        <div class="hat">${esc(a.title)}</div>
        <div class="hap">${fmtPrice(a.price)}</div>
        <div style="font-size:10px;font-weight:700;color:var(--gr)">${esc(a.city || '')}</div>
      </div>
    </div>`).join('');
}
function renderAdList(cid, ads) {
  const el = document.getElementById(cid); if (!el) return;
  if (!ads.length) {
    el.innerHTML = `<div class="empty"><span class="ei"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span><div class="et">Ничего не найдено</div><div class="es">Попробуйте другую категорию или запрос</div></div>`;
    return;
  }
  const now = Date.now();
  el.innerHTML = ads.map(a => {
    const isPinned = a.pinned_until && a.pinned_until > now;
    const isNew = (now - a.created_at) < 3600000 * 12;
    return `<div class="acard" onclick="openAd(${a.id})">
      <div class="aimg">${a.photos && a.photos.length ? `<img src="${esc(a.photos[0])}" loading="lazy">` : `<div style="color:rgba(255,255,255,.15)"><svg width="54" height="54" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></div>`}
      ${isPinned ? '<div class="pinb"><svg width="10" height="10" viewBox="0 0 24 24" fill="white" stroke="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> Закреп</div>' : ''}
      ${isNew && !isPinned ? '<div class="newb">НОВОЕ</div>' : ''}
      </div>
      <div class="ab">
        <div class="acat">${esc(a.category)}</div>
        <div class="atl">${esc(a.title)}</div>
        <div class="ame"><div class="apr">${fmtPrice(a.price)}</div><div class="ain"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> ${a.views || 0}</div></div>
        <div class="ata">
          ${a.condition ? `<div class="tag">${esc(a.condition)}</div>` : ''}
          ${a.city ? `<div class="tag"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ${esc(a.city)}</div>` : ''}
          ${a.delivery ? `<div class="tag">${esc(a.delivery.split('/')[0].trim())}</div>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

// ═══════════ AD DETAIL ═══════════
async function openAd(id) {
  const ad = [...S.ads, ...S.myAds].find(a => a.id === id); if (!ad) return;
  // Отправляем просмотр на сервер (не ждём ответа)
  sendBotAction('view_ad', { ad_id: id }).catch(() => {});
  ad.views = (ad.views || 0) + 1; save();
  S.curAdId = id; S.prevSc = S.curSc;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('sc-ad-detail').classList.add('active');
  S.curSc = 'ad-detail';
  document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));
  const slider = document.getElementById('ad-slider');
  if (ad.photos && ad.photos.length) {
    slider.innerHTML = `<img src="${esc(ad.photos[0])}" style="width:100%;height:100%;object-fit:cover">` +
      (ad.photos.length > 1 ? `<div class="asl-nav">${ad.photos.map((_, i) => `<div class="asl-dot ${i === 0 ? 'active' : ''}"></div>`).join('')}</div>` : '');
  } else {
    slider.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;color:rgba(255,255,255,.15)"><svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></div>`;
  }
  document.getElementById('ad-hdr').textContent = ad.title;
  document.getElementById('ad-det-price').textContent = fmtPrice(ad.price);
  document.getElementById('ad-det-title').textContent = ad.title;
  const rows = [
    { icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>', l: 'Категория', v: ad.category },
    { icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>', l: 'Состояние', v: ad.condition },
    ad.size ? { icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0z"/><line x1="5" y1="14" x2="9" y2="10"/></svg>', l: 'Размер', v: ad.size } : null,
    ad.city ? { icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>', l: 'Город', v: ad.city } : null,
    ad.delivery ? { icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="1"/><path d="M16 8h4l3 5v4h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>', l: 'Доставка', v: ad.delivery } : null,
    { icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>', l: 'Просмотры', v: ad.views || 0 },
    ad.desc ? { icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg>', l: 'Описание', v: ad.desc } : null,
    { icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.61 3.41 2 2 0 0 1 3.6 1.22h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L7.91 8.91a16 16 0 0 0 6 6l.92-.92a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 21.72 16.92z"/></svg>', l: 'Контакт', v: ad.contact },
  ].filter(Boolean);
  document.getElementById('ad-det-rows').innerHTML = rows.map(r => `<div class="adr"><div class="adri">${r.icon}</div><div><div class="adrk">${r.l}</div><div class="adrt">${esc(String(r.v))}</div></div></div>`).join('');
  updateFavBtn(); window.scrollTo(0, 0);
}
function contactSeller() {
  const ad = [...S.ads, ...S.myAds].find(a => a.id === S.curAdId); if (!ad) return;
  const c = ad.contact || '';
  if (c.startsWith('@') && window.Telegram?.WebApp) window.Telegram.WebApp.openTelegramLink(`https://t.me/${c.slice(1)}`);
  else if (window.Telegram?.WebApp) window.Telegram.WebApp.openLink(`tel:${c}`);
  else toast(`Контакт: ${c}`);
}

// ═══════════ FAVORITES ═══════════
async function toggleFav() {
  if (!S.curAdId) return;
  const isFav = S.favs.includes(S.curAdId);
  try {
    await sendBotAction('toggle_favorite', { ad_id: S.curAdId, add: !isFav });
    if (isFav) {
      S.favs = S.favs.filter(id => id !== S.curAdId);
      toast('Удалено из избранного');
    } else {
      S.favs.push(S.curAdId);
      toast('Добавлено в избранное');
    }
    save();
    updateFavBtn();
  } catch (e) {
    toast('Ошибка при изменении избранного');
  }
}
function updateFavBtn() {
  const f = S.favs.includes(S.curAdId);
  const h = document.getElementById('fav-hbtn'), fab = document.getElementById('fav-fab');
  if (h) h.style.color = f ? 'var(--acc)' : 'var(--gr)';
  if (fab) fab.classList.toggle('faved', f);
}
function renderFavs() {
  const favAds = S.ads.filter(a => S.favs.includes(a.id));
  if (!favAds.length) {
    document.getElementById('favs-list').innerHTML = `<div class="empty"><span class="ei"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></span><div class="et">Нет избранных</div><div class="es">Нажмите на сердечко в объявлении</div></div>`;
    return;
  }
  renderAdList('favs-list', favAds);
}

// ═══════════ MY ADS ═══════════
function setTab(tab, el) {
  S.curTab = tab;
  document.querySelectorAll('.tb').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  else { const m = { active: 'tab-active', moderation: 'tab-moderation', archive: 'tab-archive' }; const b = document.getElementById(m[tab]); if (b) b.classList.add('active'); }
  const ads = S.myAds.filter(a => tab === 'archive' ? a.status === 'inactive' || a.status === 'rejected' : a.status === (tab === 'active' ? 'active' : 'moderation'));
  const el2 = document.getElementById('my-ads-list');
  if (!ads.length) {
    const emIcons = {
      active: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
      moderation: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
      archive: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>'
    };
    const em = {
      active: [emIcons.active, 'Нет активных', 'Создайте первое!'],
      moderation: [emIcons.moderation, 'На модерации нет', 'Создайте объявление'],
      archive: [emIcons.archive, 'Архив пуст', 'Деактивируйте объявление']
    };
    const [ic, tl, sb] = em[tab] || ['<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>', 'Пусто', ''];
    el2.innerHTML = `<div class="empty"><span class="ei">${ic}</span><div class="et">${tl}</div><div class="es">${sb}</div></div>`;
    return;
  }
  const smap = { active: 's-act', moderation: 's-mod', inactive: 's-ina', rejected: 's-rej' };
  const slb = { active: 'Активно', moderation: 'На модерации', inactive: 'В архиве', rejected: 'Отклонено' };
  el2.innerHTML = ads.map(a => `
    <div class="mac" onclick="openMyAd(${a.id})">
      <div class="mat">${a.photos && a.photos.length ? `<img src="${esc(a.photos[0])}">` : `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" style="color:rgba(255,255,255,.2)"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>`}</div>
      <div class="mai">
        <div class="matl">${esc(a.title)}</div>
        <div class="map">${fmtPrice(a.price)}</div>
        <div class="mas ${smap[a.status] || 's-ina'}">${slb[a.status] || a.status}</div>
        <div class="mav"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> ${a.views || 0} · ${timeAgo(a.created_at)}</div>
      </div>
    </div>`).join('');
}
function openMyAd(id) {
  const ad = S.myAds.find(a => a.id === id); if (!ad) return;
  S.curAdId = id; S.prevSc = S.curSc; navTo('my-ad-detail');
  document.getElementById('my-ad-hdr').textContent = ad.title;
  const slb = { active: 'Активно', moderation: 'На модерации', inactive: 'В архиве', rejected: 'Отклонено' };
  const body = document.getElementById('my-ad-detail-body');
  body.innerHTML = `
    <div class="acard" style="margin-bottom:18px">
      <div class="aimg">${ad.photos && ad.photos.length ? `<img src="${esc(ad.photos[0])}">` : `<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;color:rgba(255,255,255,.15)"><svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></div>`}</div>
      <div class="ab">
        <div class="acat">${esc(ad.category)}</div>
        <div class="atl">${esc(ad.title)}</div>
        <div class="apr">${fmtPrice(ad.price)}</div>
        <div class="ata"><div class="tag">${slb[ad.status] || ad.status}</div>${ad.city ? `<div class="tag"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ${esc(ad.city)}</div>` : ''}<div class="tag"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> ${ad.views || 0}</div></div>
      </div>
    </div>
    ${ad.status === 'rejected' && ad.reject_reason ? `<div class="card" style="margin-bottom:14px;border-left:3px solid var(--rd)"><div style="font-size:12px;font-weight:800;color:var(--rd);margin-bottom:4px">Причина отказа</div><div style="font-size:13px;font-weight:600;color:var(--dk)">${esc(ad.reject_reason)}</div></div>` : ''}
    ${ad.status === 'active' ? `
      <button class="btn ba" style="margin-bottom:10px" onclick="pinMyAd(${id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="white" stroke="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> Закрепить</button>
      <button class="btn bn" style="margin-bottom:10px" onclick="deactivateAd(${id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg> В архив</button>
      <button class="btn" style="background:rgba(255,69,58,.1);color:var(--rd);box-shadow:none;border:1px solid rgba(255,69,58,.2)" onclick="deleteAd(${id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg> Удалить</button>` : ''}
    ${ad.status === 'inactive' || ad.status === 'rejected' ? `
      <button class="btn ba" style="margin-bottom:10px" onclick="reactivateAd(${id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-5.04"/></svg> Восстановить</button>
      <button class="btn" style="background:rgba(255,69,58,.1);color:var(--rd);box-shadow:none;border:1px solid rgba(255,69,58,.2)" onclick="deleteAd(${id})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg> Удалить</button>` : ''}
    ${ad.status === 'moderation' ? `<div class="card" style="text-align:center;padding:32px 18px"><div style="color:rgba(255,255,255,.2);display:flex;justify-content:center;margin-bottom:16px"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div style="font-size:15px;font-weight:700;margin-top:0;letter-spacing:-.2px">Объявление на проверке</div><div style="font-size:13px;font-weight:400;color:var(--gr);margin-top:6px">Обычно занимает 1–2 часа</div></div>` : ''}
  `;
}
function pinMyAd(id) {
  const t = TARIFFS[S.user.tariff];
  if (!t || t.pins_per_month === 0) { toast('Закреп доступен только по подписке'); setTimeout(() => navTo('subscriptions'), 800); return; }
  if ((S.user.pins_used || 0) >= t.pins_per_month) { toast(`Лимит закрепов исчерпан (${t.pins_per_month}/мес)`); return; }
  const ad = S.myAds.find(a => a.id === id);
  if (ad) {
    ad.pinned_until = Date.now() + t.pin_hours * 3600000;
    S.user.pins_used = (S.user.pins_used || 0) + 1;
    const pub = S.ads.find(a => a.id === id);
    if (pub) pub.pinned_until = ad.pinned_until;
    save(); toast(`⭐ Закреплено на ${t.pin_hours}ч!`);
    addNotif('gn', '★', 'Объявление закреплено!', `"${ad.title}" теперь в топе ${t.pin_hours}ч`);
    navBack();
  }
}
function deactivateAd(id) {
  const ad = S.myAds.find(a => a.id === id);
  if (ad) { ad.status = 'inactive'; save(); toast('Перенесено в архив'); navBack(); setTab('archive'); }
}
function reactivateAd(id) {
  const ad = S.myAds.find(a => a.id === id);
  if (ad) { ad.status = 'moderation'; save(); toast('Отправлено на модерацию'); addNotif('yl', '⏳', 'На модерации', `"${ad.title}" ждёт проверки`); navBack(); setTab('moderation'); }
}
function deleteAd(id) {
  if (!confirm('Удалить объявление?')) return;
  S.myAds = S.myAds.filter(a => a.id !== id); S.ads = S.ads.filter(a => a.id !== id);
  save(); toast('Удалено'); navBack(); setTab('active');
}

// ═══════════ CREATE AD ═══════════
function tryCreate() {
  if (!canPostAd()) return;
  S.createStep = 0; S.newAd = {}; S.photos = []; S.deliveries = [];
  document.querySelectorAll('.fst').forEach(s => s.classList.remove('active'));
  document.getElementById('step-0').classList.add('active');
  document.querySelectorAll('.cbtn').forEach(b => b.classList.remove('sel'));
  document.querySelectorAll('.ch').forEach(c => c.classList.remove('active'));
  ['ad-title','ad-desc','ad-size','ad-city','ad-contact'].forEach(id => { const e = document.getElementById(id); if (e) e.value = ''; });
  const ti = document.getElementById('ad-title'); if (ti) ti.placeholder = 'Введите название товара';
  const di = document.getElementById('ad-desc'); if (di) di.placeholder = 'Расскажите подробнее...';
  const th = document.getElementById('title-hints'); if (th) th.style.display = 'none';
  const dh = document.getElementById('desc-hints'); if (dh) dh.style.display = 'none';
  const p = document.getElementById('ad-price'); if (p) p.value = '';
  const dw = document.getElementById('deliv-other-wrap'); if (dw) dw.style.display = 'none';
  const di2 = document.getElementById('deliv-other-inp'); if (di2) di2.value = '';
  const badge = document.getElementById('create-limit-badge');
  if (badge) {
    const now = new Date().toDateString();
    if (S.user.last_daily_reset !== now) { S.user.daily_ads = 0; S.user.last_daily_reset = now; save(); }
    const tariffName = S.user.tariff || 'Free';
    const lim = TARIFFS[tariffName] ? TARIFFS[tariffName].daily_ads : 1;
    const used = S.user.daily_ads || 0;
    const left = lim >= 50 ? '∞' : (lim - used);
    badge.textContent = `${used}/${lim === Infinity ? '∞' : lim}`;
    badge.style.color = used >= lim ? 'var(--rd)' : 'var(--acc)';
    badge.style.background = used >= lim ? 'rgba(244,67,54,.12)' : 'rgba(255,87,34,.1)';
  }
  renderPhotoGrid(); updateStepi(); navTo('create');
}
function canPostAd() {
  if (S.user.tariff !== 'Free' && S.user.tariff_end && Date.now() > S.user.tariff_end) {
    S.user.tariff = 'Free'; S.user.tariff_end = null; save();
  }
  const now = new Date().toDateString();
  if (S.user.last_daily_reset !== now) { S.user.daily_ads = 0; S.user.last_daily_reset = now; save(); }
  const tariffName = S.user.tariff || 'Free';
  const lim = TARIFFS[tariffName] ? TARIFFS[tariffName].daily_ads : 1;
  const used = S.user.daily_ads || 0;
  if (used >= lim) {
    if (tariffName === 'Free') {
      toast('Лимит Free: 1 объявление в день. Оформите подписку!');
      setTimeout(() => navTo('subscriptions'), 1200);
    } else {
      toast(`Лимит объявлений в день: ${lim === Infinity ? 'безлимит' : lim}`);
    }
    return false;
  }
  return true;
}
function updateStepi() {
  document.getElementById('stepi').innerHTML = Array.from({ length: 4 }, (_, i) => `<div class="sdt ${i < S.createStep ? 'done' : ''}"></div>`).join('');
}
function selCat(cat, el) {
  document.querySelectorAll('.cbtn').forEach(b => b.classList.remove('sel'));
  el.classList.add('sel'); S.newAd.category = cat;
  const tpl = CAT_TEMPLATES[cat] || CAT_TEMPLATES['Другое'];
  const ti = document.getElementById('ad-title');
  const di = document.getElementById('ad-desc');
  const si = document.getElementById('ad-size');
  if (ti) ti.placeholder = tpl.title;
  if (di) di.placeholder = tpl.desc;
  const hasSz = tpl.size !== '';
  document.getElementById('size-gr').style.display = hasSz ? 'block' : 'none';
  if (si && tpl.size) si.placeholder = tpl.size;
  const hc = document.getElementById('title-hints');
  if (hc) {
    hc.innerHTML = tpl.hints.map((h, i) => `<button class="cat-hint" style="animation-delay:${i * 0.04}s" onclick="applyHint('title','${h}')">${h}</button>`).join('');
    hc.style.display = 'flex';
  }
  const dhc = document.getElementById('desc-hints');
  if (dhc) {
    dhc.innerHTML = tpl.descHints.map((h, i) => `<button class="cat-hint" style="animation-delay:${i * 0.04}s" onclick="applyDescHint('${h.replace(/'/g, "\\'")}')">+ ${h}</button>`).join('');
    dhc.style.display = 'flex';
  }
  setTimeout(() => nextStep(), 280);
}
function applyHint(field, val) { const el = document.getElementById('ad-' + field); if (el) { el.value = val; el.focus(); } }
function applyDescHint(val) {
  const el = document.getElementById('ad-desc'); if (!el) return;
  const cur = el.value.trim();
  el.value = cur ? (cur + ' ' + val) : val;
  el.focus();
  el.setSelectionRange(el.value.length, el.value.length);
}
function selChip(el, field, val) {
  el.parentElement.querySelectorAll('.ch').forEach(c => c.classList.remove('active'));
  el.classList.add('active'); S.newAd[field] = val;
}
function togDeliv(el, val) {
  el.classList.toggle('active');
  if (el.classList.contains('active')) S.deliveries.push(val);
  else S.deliveries = S.deliveries.filter(d => d !== val);
}
function togDelivOther(el) {
  el.classList.toggle('active');
  const wrap = document.getElementById('deliv-other-wrap');
  if (el.classList.contains('active')) { wrap.style.display = 'block'; }
  else { wrap.style.display = 'none'; S.deliveries = S.deliveries.filter(d => !d.startsWith('Другое')); }
}
function updateDelivOther(val) {
  S.deliveries = S.deliveries.filter(d => !d.startsWith('Другое'));
  if (val.trim()) S.deliveries.push('Другое: ' + val.trim());
}
function nextStep() {
  if (S.createStep === 1) {
    if (!document.getElementById('ad-title').value.trim()) { toast('Введите название товара'); return; }
    if (!S.newAd.condition) { toast('Выберите состояние товара'); return; }
    S.newAd.title = document.getElementById('ad-title').value.trim();
    S.newAd.size = document.getElementById('ad-size').value.trim();
    S.newAd.desc = document.getElementById('ad-desc').value.trim();
  }
  if (S.createStep === 2) {
    const priceEl = document.getElementById('ad-price');
    S.newAd.price = priceEl.value ? parseInt(priceEl.value) : 0;
    S.newAd.city = document.getElementById('ad-city').value.trim();
    S.newAd.delivery = S.deliveries.join(' / ');
  }
  if (S.createStep === 4) { renderCreatePreview(); }
  document.getElementById(`step-${S.createStep}`).classList.remove('active');
  S.createStep++;
  document.getElementById(`step-${S.createStep}`).classList.add('active');
  updateStepi(); window.scrollTo(0, 0);
}
function backCreate() {
  if (S.createStep > 0) {
    document.getElementById(`step-${S.createStep}`).classList.remove('active');
    S.createStep--;
    document.getElementById(`step-${S.createStep}`).classList.add('active');
    updateStepi();
  } else { navTo('home'); }
}
function renderPhotoGrid() {
  const g = document.getElementById('photo-grid'); if (!g) return;
  const dropzone = document.getElementById('photo-dropzone');
  const addMore = document.getElementById('photo-add-more');
  if (S.photos.length === 0) {
    if (dropzone) dropzone.style.display = 'flex';
    if (addMore) addMore.style.display = 'none';
    g.innerHTML = ''; g.style.display = 'none';
  } else {
    if (dropzone) dropzone.style.display = 'none';
    g.style.display = 'flex';
    g.innerHTML = S.photos.map((p, i) => `<div class="psl"><img src="${p}"><div class="rmv" onclick="removePhoto(${i})"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></div>${i === 0 ? '<div style="position:absolute;bottom:0;left:0;right:0;background:rgba(255,87,34,.75);font-size:9px;font-weight:900;color:#fff;text-align:center;padding:3px 0;letter-spacing:.5px">ГЛАВНОЕ</div>' : ''}</div>`).join('');
    if (addMore) addMore.style.display = S.photos.length < 10 ? 'block' : 'none';
  }
}
function removePhoto(i) { S.photos.splice(i, 1); renderPhotoGrid(); }
function handlePhotos(inp) {
  const files = Array.from(inp.files), rem = 10 - S.photos.length;
  files.slice(0, rem).forEach(f => {
    const r = new FileReader();
    r.onload = e => { S.photos.push(e.target.result); renderPhotoGrid(); };
    r.readAsDataURL(f);
  });
  if (files.length > rem) toast(`Макс. 10 фото. Добавлено ${rem}`);
  inp.value = '';
}
function renderCreatePreview() {
  const p = document.getElementById('create-preview'); if (!p) return;
  p.innerHTML = `<div class="card"><div style="font-size:13px;font-weight:800;color:var(--gr);margin-bottom:10px">ПРЕДПРОСМОТР</div>
    <div style="font-size:11px;font-weight:800;color:var(--acc)">${esc(S.newAd.category || '')}</div>
    <div style="font-size:16px;font-weight:800;margin:4px 0">${esc(S.newAd.title || '')}</div>
    <div style="font-size:20px;font-weight:900;color:var(--acc)">${fmtPrice(S.newAd.price || 0)}</div>
    <div style="font-size:13px;color:var(--gr);margin-top:6px">${esc(S.newAd.condition || '')} ${S.newAd.city ? '· ' + S.newAd.city : ''}</div>
  </div>`;
}
async function submitAd() {
  S.newAd.contact = document.getElementById('ad-contact').value.trim();
  if (!S.newAd.contact) { toast('Введите контакт для связи'); return; }
  if (!canPostAd()) return;

  const adData = {
    title: S.newAd.title || 'Новое',
    price: S.newAd.price || 0,
    category: S.newAd.category || 'Другое',
    condition: S.newAd.condition || '',
    size: S.newAd.size || '',
    city: S.newAd.city || '',
    delivery: S.newAd.delivery || '',
    description: S.newAd.desc || '',
    contact_info: S.newAd.contact,
    photos: S.photos.slice()
  };

  try {
    const response = await sendBotAction('create_ad', { ad_data: adData });
    if (response.ok) {
      toast('Объявление отправлено на модерацию!');
      setTimeout(() => navTo('home'), 1200);
    } else {
      toast('Ошибка: ' + (response.error || 'Неизвестная ошибка'));
    }
  } catch (e) {
    toast('Ошибка соединения с сервером');
    console.error(e);
  }
}

// ═══════════ PROFILE ═══════════
function renderProfile() {
  document.getElementById('prof-name').textContent = S.user.name;
  document.getElementById('prof-sub').textContent = `Тариф: ${S.user.tariff}${S.user.tariff_end ? ` · до ${new Date(S.user.tariff_end).toLocaleDateString('ru')}` : ' (бесплатный)'}`;
  document.getElementById('prof-tariff').textContent = S.user.tariff;
  document.getElementById('prof-ads').textContent = S.myAds.filter(a => a.status === 'active').length;
  document.getElementById('prof-views').textContent = S.myAds.reduce((s, a) => s + (a.views || 0), 0);
  document.getElementById('ref-bal-prof').textContent = (S.user.ref_balance || 0) + '₽';
  const unread = S.notifs.filter(n => !n.read).length;
  document.getElementById('notif-count-prof').textContent = unread ? unread + ' новых' : '';
  if (S.user.tg_id) document.getElementById('prof-id').textContent = 'ID: ' + S.user.tg_id;
  const isAdmin = ADMIN_USER_IDS.includes(S.user.tg_id);
  document.getElementById('admin-row').style.display = isAdmin ? 'flex' : 'none';
  document.getElementById('admin-sep').style.display = isAdmin ? 'block' : 'none';
}

// ═══════════ SUBSCRIPTIONS ═══════════
function renderSubs() {
  const disc = S.promoDiscount;
  document.getElementById('std-price').innerHTML = disc ? `<s style="font-size:20px;opacity:.5">299₽</s> ${Math.round(299 * (1 - disc / 100))}₽ <span>/мес</span>` : `299₽ <span>/мес</span>`;
  document.getElementById('pro-price').innerHTML = disc ? `<s style="font-size:20px;opacity:.8">899₽</s> ${Math.round(899 * (1 - disc / 100))}₽ <span>/мес</span>` : `899₽ <span>/мес</span>`;
}
function applyPromo() {
  const code = document.getElementById('promo-inp').value.trim().toUpperCase();
  const promo = S.promoCodes.find(p => p.code === code && p.active && p.uses < p.max_uses);
  if (!promo) { toast('Промокод не найден или истёк'); return; }
  S.promoDiscount = promo.discount; S.promoCode = code;
  promo.uses++; save();
  document.getElementById('promo-applied').style.display = 'block';
  document.getElementById('promo-applied').innerHTML = `<div style="background:rgba(191,90,242,.1);border-radius:var(--rs);padding:10px 14px;font-size:13px;font-weight:700;color:var(--pu)">Промокод <b>${code}</b> применён — скидка ${promo.discount}%!</div>`;
  renderSubs(); toast(`Промокод применён! Скидка ${promo.discount}%`);
}

// ═══════════ PAYMENT MODAL ═══════════
function openPayment(tariff) {
  S.selPayTariff = tariff; S.selPayMethod = '';
  const prices = { Standard: 299, PRO: 899 };
  const basePrice = prices[tariff] || 0;
  const disc = S.promoDiscount;
  const finalPrice = disc ? Math.round(basePrice * (1 - disc / 100)) : basePrice;
  const html = `
    <button class="mclose" onclick="closeModal()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    <div style="font-size:18px;font-weight:900;color:var(--dk);margin-bottom:6px;padding-right:40px">Оплата тарифа ${tariff}</div>
    <div style="font-size:13px;font-weight:600;color:var(--gr);margin-bottom:18px">Сумма: <b style="color:var(--acc);font-size:16px">${finalPrice}₽</b>${disc ? ` <s style="opacity:.5">${basePrice}₽</s> (−${disc}%)` : ''}</div>
    <div style="font-size:12px;font-weight:800;color:var(--gr);text-transform:uppercase;letter-spacing:.4px;margin-bottom:12px">Способ оплаты</div>
    <div class="pm" onclick="selPayMethod('yoomoney',this)">
      <div class="pmic" style="background:linear-gradient(135deg,#8B5CF6,#6D28D9)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M8 12h8M12 8v8"/></svg></div>
      <div><div class="pmt">ЮMoney</div><div class="pmst">Мгновенно</div></div>
    </div>
    <div class="pm" onclick="selPayMethod('crypto',this)">
      <div class="pmic" style="background:linear-gradient(135deg,#F59E0B,#D97706)">₿</div>
      <div><div class="pmt">Крипто (USDT)</div><div class="pmst">через @wallet</div></div>
    </div>
    <div class="pm" onclick="selPayMethod('tinkoff',this)">
      <div class="pmic" style="background:linear-gradient(135deg,#FBBF24,#F59E0B)"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg></div>
      <div><div class="pmt">Тинькофф</div><div class="pmst">Номер карты: ${PAYMENT_DETAILS.tinkoff_account}</div></div>
    </div>
    <div style="margin-top:18px">
      <button class="btn ba" id="pay-confirm-btn" onclick="confirmPayStep()" style="display:none">Перейти к оплате →</button>
    </div>
    <div style="font-size:12px;font-weight:600;color:var(--lg);text-align:center;margin-top:12px">После оплаты пришлите чек в @${BOT_NAME}</div>
  `;
  showModal(html);
}
function selPayMethod(method, el) {
  S.selPayMethod = method;
  document.querySelectorAll('.pm').forEach(p => p.classList.remove('sel'));
  el.classList.add('sel');
  document.getElementById('pay-confirm-btn').style.display = 'flex';
}
function confirmPayStep() {
  if (!S.selPayMethod) { toast('Выберите способ оплаты'); return; }
  const t = S.selPayTariff, m = S.selPayMethod;
  const links = {
    yoomoney: t === 'Standard' ? PAYMENT_DETAILS.yoomoney_standard : PAYMENT_DETAILS.yoomoney_pro,
    crypto: t === 'Standard' ? PAYMENT_DETAILS.crypto_standard : PAYMENT_DETAILS.crypto_pro,
    tinkoff: null
  };
  const link = links[m];
  if (link && window.Telegram?.WebApp) window.Telegram.WebApp.openLink(link);
  else if (link) window.open(link, '_blank');
  
  const paymentInfo = {
    id: Date.now(),
    tariff: t,
    method: m,
    amount: Math.round((t === 'PRO' ? 899 : 299) * (1 - S.promoDiscount / 100)),
    promocode: S.promoCode || null,
    discount: S.promoDiscount || 0,
    status: 'pending',
    created_at: new Date().toISOString()
  };
  
  if (window.Telegram?.WebApp) {
    try {
      window.Telegram.WebApp.sendData(JSON.stringify({
        action: 'payment_initiated',
        payment_data: paymentInfo
      }));
    } catch (e) { console.error('Ошибка отправки платежа боту:', e); }
  }
  
  const mb = document.getElementById('modal-body');
  mb.innerHTML = `
    <button class="mclose" onclick="closeModal()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    <div style="text-align:center;padding:10px 0 20px">
      <div style="margin-bottom:12px;display:flex;justify-content:center;color:rgba(255,255,255,.2)"><svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
      <div style="font-size:18px;font-weight:900;color:var(--dk);margin-bottom:8px">Отправьте чек</div>
      <div style="font-size:14px;font-weight:600;color:var(--gr);margin-bottom:20px">После оплаты отправьте скриншот чека боту @${BOT_NAME} — мы проверим и активируем тариф в течение часа</div>
      <button class="btn ba" onclick="openBotForPayment('${paymentInfo.id}')">Отправить чек в бот →</button>
      <button class="btn bg" style="margin-top:10px" onclick="closeModal()">Закрыть</button>
    </div>
  `;
  S.payments.push(paymentInfo);
  save();
  addNotif('yl', '💳', 'Платёж ожидает подтверждения', `Отправьте чек в @${BOT_NAME}`);
}
function openBotForPayment(paymentId) {
  if (window.Telegram?.WebApp) {
    window.Telegram.WebApp.openTelegramLink(`https://t.me/${BOT_NAME}?start=payment_${paymentId}`);
  } else {
    window.open(`https://t.me/${BOT_NAME}?start=payment_${paymentId}`, '_blank');
  }
  closeModal();
}

// ═══════════ REFERRAL ═══════════
function renderReferral() {
  document.getElementById('ref-bal').textContent = (S.user.ref_balance || 0) + '₽';
  document.getElementById('ref-total').textContent = (S.user.ref_total || 0) + '₽';
  document.getElementById('ref-cnt').textContent = S.referrals.length;
  document.getElementById('ref-act').textContent = S.referrals.filter(r => r.bought).length;
  document.getElementById('ref-link').textContent = `https://t.me/${BOT_NAME}?start=ref_${S.user.tg_id || '0'}`;
  const el = document.getElementById('ref-list');
  if (!S.referrals.length) {
    el.innerHTML = `<div class="empty" style="padding:24px"><span class="ei"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span><div class="et" style="font-size:15px">Нет рефералов</div><div class="es">Поделитесь ссылкой!</div></div>`;
    return;
  }
  el.innerHTML = S.referrals.map(r => `
    <div class="rc">
      <div class="rav"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.58-7 8-7s8 3 8 7"/></svg></div>
      <div style="flex:1"><div class="rn">${esc(r.name)}</div><div class="rd-row">${r.bought ? 'Купил подписку' : 'Зарегистрировался'}</div></div>
      <div class="rr">${r.bought ? '+' + Math.round((S.user.tariff === 'PRO' ? 899 : 299) * REFERRAL_PERCENT / 100) + '₽' : '—'}</div>
    </div>`).join('');
}
function copyRef() {
  const link = document.getElementById('ref-link').textContent;
  navigator.clipboard?.writeText(link).then(() => toast('Ссылка скопирована!')).catch(() => toast(link));
}
function shareRef() {
  const link = document.getElementById('ref-link').textContent;
  if (window.Telegram?.WebApp) {
    window.Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent('Присоединяйся к Postcrab — удобная доска объявлений! 🦀')}`);
  } else toast('Скопируйте ссылку и поделитесь ею');
}

// ═══════════ PIN AD ═══════════
function renderPinAd() {
  const t = TARIFFS[S.user.tariff || 'Free'];
  const el = document.getElementById('pin-ad-list');
  const activeAds = S.myAds.filter(a => a.status === 'active');
  if (t.pins_per_month === 0) {
    el.innerHTML = `<div class="card" style="text-align:center;padding:28px 18px"><div style="margin-bottom:14px;display:flex;justify-content:center;color:rgba(255,255,255,.15)"><svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div><div style="font-size:15px;font-weight:700;margin:10px 0 6px;letter-spacing:-.1px">Нет доступных закрепов</div><div style="font-size:13px;font-weight:600;color:var(--gr);margin-bottom:14px">Оформите подписку чтобы закреплять объявления</div><button class="btn ba" onclick="navTo('subscriptions')">Смотреть тарифы</button></div>`;
    return;
  }
  if (!activeAds.length) {
    el.innerHTML = `<div class="empty"><span class="ei"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span><div class="et">Нет активных объявлений</div></div>`;
    return;
  }
  const used = S.user.pins_used || 0;
  el.innerHTML = `<div style="background:rgba(255,87,34,.08);border-radius:var(--rs);padding:12px 14px;margin-bottom:14px;font-size:13px;font-weight:700;color:var(--acc)">Использовано закрепов: ${used}/${t.pins_per_month} этот месяц</div>` +
    activeAds.map(a => {
      const pinned = a.pinned_until && a.pinned_until > Date.now();
      return `<div class="mac" onclick="${pinned ? `toast('Уже закреплено до '+new Date(${a.pinned_until}).toLocaleDateString("ru"))` : `pinMyAd(${a.id})`}">
        <div class="mat">${a.photos && a.photos.length ? `<img src="${esc(a.photos[0])}">` : `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.2)" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>`}</div>
        <div class="mai"><div class="matl">${esc(a.title)}</div><div class="map">${fmtPrice(a.price)}</div>
        <div class="mas ${pinned ? 's-act' : 's-ina'}">${pinned ? `⭐ Закреп до ${new Date(a.pinned_until).toLocaleDateString('ru')}` : 'Не закреплено'}</div>
      </div></div>`;
    }).join('');
}

// ═══════════ NOTIFICATIONS ═══════════
function addNotif(cls, icon, title, body) {
  const n = { id: Date.now() + Math.random(), iconCls: 'nic-' + cls, icon, title, body, time: Date.now(), read: false };
  S.notifs.unshift(n); S.notifs = S.notifs.slice(0, 50); save(); updateNavBadge();
}
function renderNotifications() {
  const el = document.getElementById('notif-list');
  if (!S.notifs.length) {
    el.innerHTML = `<div class="empty"><span class="ei"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></span><div class="et">Нет уведомлений</div></div>`;
    return;
  }
  el.innerHTML = S.notifs.map(n => `
    <div class="notif-item ${n.read ? '' : 'unread'}" onclick="readNotif(${n.id})">
      <div class="notif-ic ${n.iconCls || 'nic-bl'}">${n.icon}</div>
      <div style="flex:1"><div class="notif-tl">${esc(n.title)}</div><div class="notif-bd" style="color:var(--gr);font-size:12px">${esc(n.body)}</div><div style="font-size:10px;font-weight:600;color:var(--lg);margin-top:3px">${timeAgo(n.time)}</div></div>
    </div>`).join('');
  setTimeout(() => { S.notifs.forEach(n => n.read = true); save(); updateNavBadge(); }, 1500);
}
function readNotif(id) { S.notifs.forEach(n => { if (n.id === id) n.read = true; }); save(); updateNavBadge(); }
function markAllRead() { S.notifs.forEach(n => n.read = true); save(); updateNavBadge(); renderNotifications(); }
function updateNavBadge() {
  const cnt = S.notifs.filter(n => !n.read).length;
  const dot = document.getElementById('notif-dot'), dot2 = document.getElementById('notif-dot2');
  const badge = document.getElementById('nav-profile-badge');
  if (dot) dot.style.display = cnt ? 'block' : 'none';
  if (dot2) dot2.style.display = cnt ? 'block' : 'none';
  if (badge) { badge.style.display = cnt ? 'flex' : 'none'; badge.textContent = cnt > 9 ? '9+' : cnt; }
}
function showPushNotif(cls, icon, title, body) {
  const bar = document.getElementById('notif-bar');
  const n = document.createElement('div');
  n.className = 'notif';
  n.innerHTML = `<div class="notif-ic nic-${cls}">${icon}</div><div><div class="notif-tl">${esc(title)}</div><div class="notif-bd">${esc(body)}</div></div>`;
  n.onclick = () => { n.remove(); navTo('notifications'); };
  bar.appendChild(n);
  setTimeout(() => { n.style.transition = 'all .4s ease'; n.style.opacity = '0'; n.style.transform = 'translateX(110%)'; setTimeout(() => n.remove(), 400); }, 4000);
}

// ═══════════ ADMIN ═══════════
function renderAdmin() {
  const isAdmin = ADMIN_USER_IDS.includes(S.user.tg_id);
  if (!isAdmin) { toast('Нет доступа'); navBack(); return; }
  document.getElementById('stat-users').textContent = S.referrals.length + 1;
  const allAds = [...S.ads, ...S.myAds.filter(a => !S.ads.find(x => x.id === a.id))];
  document.getElementById('stat-ads').textContent = allAds.length;
  document.getElementById('stat-active').textContent = allAds.filter(a => a.status === 'active').length;
  document.getElementById('stat-mod').textContent = allAds.filter(a => a.status === 'moderation').length;
  // Moderation queue
  const modAds = S.myAds.filter(a => a.status === 'moderation');
  const mq = document.getElementById('admin-mod-queue');
  if (!modAds.length) { mq.innerHTML = `<div style="font-size:13px;font-weight:600;color:var(--gr);padding:12px 0">Нет объявлений на модерации</div>`; }
  else {
    mq.innerHTML = modAds.map(a => `
      <div class="mod-card">
        <div class="mod-img">${a.photos && a.photos.length ? `<img src="${esc(a.photos[0])}">` : `<div style="color:rgba(255,255,255,.15)"><svg width="54" height="54" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></div>`}</div>
        <div class="mod-body">
          <div class="mod-title">${esc(a.title)}</div>
          <div class="mod-meta">${fmtPrice(a.price)} · ${esc(a.category)} · ${esc(a.city || '—')}</div>
          <div style="display:flex;gap:8px">
            <button class="btn ba" style="flex:1;padding:11px" onclick="moderateAd(${a.id},true)">Одобрить</button>
            <button class="btn" style="flex:1;padding:11px;background:rgba(255,69,58,.1);border:1px solid rgba(255,69,58,.2);color:var(--rd);box-shadow:none" onclick="moderateAd(${a.id},false)">Отклонить</button>
          </div>
        </div>
      </div>`).join('');
  }
  // Payments
  const pendPay = S.payments.filter(p => p.status === 'pending');
  const pl = document.getElementById('admin-payments-list');
  if (!pendPay.length) { pl.innerHTML = `<div style="font-size:13px;font-weight:600;color:var(--gr);padding:12px 0">Нет ожидающих платежей</div>`; }
  else {
    pl.innerHTML = pendPay.map(p => `
      <div class="admin-card">
        <div style="font-size:14px;font-weight:800;margin-bottom:4px">Тариф ${p.tariff} · ${p.amount}₽</div>
        <div style="font-size:12px;font-weight:600;color:var(--gr);margin-bottom:10px">${p.method} · ${timeAgo(p.created_at)}${p.promo ? ` · Промокод: ${p.promo}` : ''}</div>
        <div style="display:flex;gap:8px">
          <button class="btn ba" style="flex:1;padding:11px" onclick="approvePayment(${p.id})">Подтвердить</button>
          <button class="btn" style="flex:1;padding:11px;background:rgba(255,69,58,.1);border:1px solid rgba(255,69,58,.2);color:var(--rd);box-shadow:none" onclick="rejectPayment(${p.id})">Отклонить</button>
        </div>
      </div>`).join('');
  }
  // Promos
  const pl2 = document.getElementById('promo-list-admin');
  if (!S.promoCodes.length) { pl2.innerHTML = `<div style="font-size:13px;font-weight:600;color:var(--gr);padding:4px 0">Нет промокодов</div>`; }
  else {
    pl2.innerHTML = S.promoCodes.map(p => `
      <div class="admin-card" style="display:flex;align-items:center;gap:12px">
        <div style="flex:1"><div style="font-size:15px;font-weight:900;color:var(--dk)">${esc(p.code)}</div>
        <div style="font-size:12px;font-weight:600;color:var(--gr)">−${p.discount}% · ${p.uses}/${p.max_uses} использований</div></div>
        <div onclick="deactivatePromo('${p.code}')" style="font-size:12px;font-weight:800;color:${p.active ? 'var(--rd)' : 'var(--gr)'};cursor:pointer">${p.active ? 'Откл.' : 'Откл.'}</div>
      </div>`).join('');
  }
}
function moderateAd(id, approve) {
  const ad = S.myAds.find(a => a.id === id); if (!ad) return;
  if (approve) {
    ad.status = 'active';
    if (!S.ads.find(x => x.id === id)) S.ads.unshift({ ...ad });
    addNotif('gn', '✅', 'Объявление опубликовано!', `"${ad.title}" теперь в ленте`);
    showPushNotif('gn', '✅', 'Объявление опубликовано!', `"${ad.title}" теперь в ленте`);
    toast('Объявление одобрено');
  } else {
    const reason = prompt('Причина отказа (необязательно):', 'Не соответствует правилам');
    ad.status = 'rejected'; ad.reject_reason = reason || 'Не соответствует правилам';
    addNotif('rd', '❌', 'Объявление отклонено', `"${ad.title}": ${ad.reject_reason}`);
    toast('Объявление отклонено');
  }
  save(); renderAdmin();
}
function approvePayment(id) {
  const p = S.payments.find(x => x.id === id); if (!p) return;
  p.status = 'approved'; p.confirmed_at = Date.now();
  S.user.tariff = p.tariff;
  S.user.tariff_end = Date.now() + 30 * 86400000;
  S.user.pins_used = 0;
  save();
  addNotif('gn', '🎉', 'Подписка активирована!', `Тариф ${p.tariff} активен до ${new Date(S.user.tariff_end).toLocaleDateString('ru')}`);
  showPushNotif('gn', '🎉', 'Подписка активирована!', `Тариф ${p.tariff} активен до ${new Date(S.user.tariff_end).toLocaleDateString('ru')}`);
  toast('Платёж подтверждён, тариф активирован');
  renderAdmin();
}
function rejectPayment(id) {
  const p = S.payments.find(x => x.id === id); if (!p) return;
  p.status = 'rejected'; save();
  addNotif('rd', '❌', 'Платёж отклонён', `Тариф ${p.tariff}. Обратитесь в поддержку`);
  toast('Платёж отклонён'); renderAdmin();
}
function sendBroadcast() {
  const text = document.getElementById('broadcast-text').value.trim();
  if (!text) { toast('Введите текст рассылки'); return; }
  if (window.Telegram?.WebApp) {
    try {
      window.Telegram.WebApp.sendData(JSON.stringify({ action: 'broadcast', text }));
      toast('Рассылка отправлена через бот!');
    } catch (e) { console.error('Ошибка рассылки:', e); toast('Ошибка отправки рассылки'); return; }
  } else {
    addNotif('bl', '📢', 'Сообщение от администратора', text);
    showPushNotif('bl', '📢', 'Рассылка от администратора', text);
    toast('Рассылка отправлена (дев-режим)');
  }
  document.getElementById('broadcast-text').value = '';
}
function showPromoCreate() {
  const html = `
    <button class="mclose" onclick="closeModal()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    <div style="font-size:18px;font-weight:900;margin-bottom:18px">Создать промокод</div>
    <div class="fgr"><label class="flb">Код промокода</label><input class="inp" id="new-promo-code" placeholder="POST20" style="text-transform:uppercase"></div>
    <div class="fgr"><label class="flb">Скидка (%)</label><input class="inp" id="new-promo-disc" type="number" min="5" max="80" placeholder="20"></div>
    <div class="fgr"><label class="flb">Макс. использований</label><input class="inp" id="new-promo-uses" type="number" min="1" placeholder="50"></div>
    <button class="btn ba" onclick="createPromo()">Создать</button>
  `;
  showModal(html);
}
function createPromo() {
  const code = (document.getElementById('new-promo-code').value || '').toUpperCase().trim();
  const disc = parseInt(document.getElementById('new-promo-disc').value) || 0;
  const uses = parseInt(document.getElementById('new-promo-uses').value) || 100;
  if (!code) { toast('Введите код'); return; }
  if (disc < 5 || disc > 80) { toast('Скидка 5–80%'); return; }
  if (S.promoCodes.find(p => p.code === code)) { toast('Такой промокод уже есть'); return; }
  S.promoCodes.push({ code, discount: disc, duration: 30, max_uses: uses, uses: 0, active: true, created_at: Date.now() });
  save(); toast('Промокод создан!'); closeModal(); renderAdmin();
}
function deactivatePromo(code) {
  const p = S.promoCodes.find(x => x.code === code); if (p) p.active = !p.active; save(); renderAdmin();
}

// ═══════════ MODAL ═══════════
function showModal(html) {
  document.getElementById('modal-body').innerHTML = html;
  document.getElementById('overlay').classList.add('show');
}
function closeModal() { document.getElementById('overlay').classList.remove('show'); }
function closeOverlay(e) { if (e.target === document.getElementById('overlay')) closeModal(); }

// ═══════════ INIT ═══════════
window.addEventListener('load', async () => {
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();
    const u = tg.initDataUnsafe?.user;
    if (u) {
      _storagePrefix = 'pc_' + u.id + '_';
      // Загружаем из localStorage (быстро)
      S.user = LS('user') || { name: u.first_name + (u.last_name ? ' ' + u.last_name : ''), tg_id: u.id, tariff: 'Free', tariff_end: null, pins_used: 0, ref_balance: 0, ref_total: 0, daily_ads: 0, last_daily_reset: null, views_total: 0 };
      S.ads = LS('ads') || [];
      S.myAds = LS('my_ads') || [];
      S.favs = LS('favs') || [];
      S.notifs = LS('notifs') || [];
      S.promoCodes = LS('promos') || [];
      S.payments = LS('payments') || [];
      S.referrals = LS('refs') || [];
      S.searchHist = LS('search_hist') || [];
      S.user.name = u.first_name + (u.last_name ? ' ' + u.last_name : '');
      S.user.tg_id = u.id;
      S.user.username = u.username || '';
      
      // Затем обновляем с сервера
      await loadInitialData();
    }
  }
  // Обработка URL параметров (для обновления тарифа после оплаты)
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('refresh') === '1') {
    const tariff = urlParams.get('tariff');
    const tariffEnd = urlParams.get('tariff_end');
    if (tariff) {
      S.user.tariff = tariff;
      S.user.tariff_end = tariffEnd ? new Date(tariffEnd).getTime() : Date.now() + 30 * 86400000;
      S.user.pins_used = 0;
      save();
      toast(`Тариф ${tariff} активирован!`);
      setTimeout(() => { renderProfile(); renderSubs(); navTo('profile'); }, 800);
    }
  }
  initDemo();
  renderHome(); renderPinned();
  updateNavBadge();
  if (S.user.tariff !== 'Free' && S.user.tariff_end && Date.now() > S.user.tariff_end) {
    const old = S.user.tariff;
    S.user.tariff = 'Free'; S.user.tariff_end = null; save();
    addNotif('rd', '⏰', 'Подписка закончилась', `Тариф ${old} истёк. Продлите для сохранения привилегий.`);
    showPushNotif('rd', '⏰', 'Подписка закончилась', `Тариф ${old} истёк`);
  }
});
</script>
</body>
</html>
